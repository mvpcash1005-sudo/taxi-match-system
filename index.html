<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆå«è»Šç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        /* æ‰¿è¥²åŸæœ‰çš„é»‘é‡‘é¢¨æ ¼ */
        body { background-color: #121212; color: #e0e0e0; font-family: sans-serif; margin: 0; padding-bottom: 80px; }
        .header { background: #1e1e1e; padding: 15px; text-align: center; border-bottom: 1px solid #333; }
        .role-switcher { display: flex; background: #222; padding: 5px; border-radius: 25px; margin: 10px 20px; }
        .role-btn { flex: 1; padding: 8px; text-align: center; border-radius: 20px; cursor: pointer; font-size: 14px; }
        .role-btn.active { background: #00e676; color: #000; font-weight: bold; }
        
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; position: relative; }
        
        /* æ¶å–®å‹•ç•«æ•ˆæœ */
        .order-flash { border: 2px solid #00e676; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,230,118,0.4); } 70% { box-shadow: 0 0 0 10px rgba(0,230,118,0); } 100% { box-shadow: 0 0 0 0 rgba(0,230,118,0); } }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-waiting { background: #ff9800; color: white; }
        .status-accepted { background: #2196f3; color: white; }
        .status-done { background: #4caf50; color: white; }

        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: #2c2c2c; color: #fff; font-size: 16px; box-sizing: border-box; }
        .btn-main { background: #00e676; color: #000; font-weight: bold; border: none; cursor: pointer; }
        .btn-grab { background: #ff5252; color: white; animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-2px); } 75% { transform: translateX(2px); } }

        /* è©•åƒ¹å€å¡Š */
        .rating-box { display: none; margin-top: 10px; border-top: 1px dashed #444; padding-top: 10px; }
        .star-input { color: #ffeb3b; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0; color:#00e676;">Jasper æ™ºæ…§åª’åˆç³»çµ±</h2>
    <div id="clock" style="font-size: 12px; color: #888;">æ­£åœ¨è®€å–ç²¾æº–æ™‚é–“...</div>
</div>

<div class="role-switcher">
    <div class="role-btn active" onclick="setUserRole('passenger')">æˆ‘æ˜¯ä¹˜å®¢ (ç™¼å–®)</div>
    <div class="role-btn" onclick="setUserRole('driver')">æˆ‘æ˜¯å¸æ©Ÿ (æ¶å–®)</div>
</div>

<div class="container">
    <div id="passenger-ui">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ“ å»ºç«‹å«è»Šéœ€æ±‚</h3>
            <input type="text" id="p-start" placeholder="ä¸Šè»Šåœ°å€ (ä¾‹: æ¿æ©‹è»Šç«™)">
            <input type="text" id="p-end" placeholder="ä¸‹è»Šåœ°å€ (ä¾‹: æ¡ƒåœ’æ©Ÿå ´)">
            <button class="btn-main" onclick="submitOrder()">ğŸš€ ç«‹å³ç™¼é€æ¶å–®éœ€æ±‚</button>
        </div>
        <div id="my-orders">
            <h4>æˆ‘çš„è¨‚å–®ç‹€æ…‹</h4>
            </div>
    </div>

    <div id="driver-ui" style="display:none;">
        <div id="available-orders">
            <h4 style="text-align:center; color:#888;">ğŸ“¡ æ­£åœ¨æƒæå‘¨é‚Šè¨‚å–®...</h4>
            </div>
    </div>
</div>

<script>
    // --- 1. Firebase åˆå§‹åŒ– (è«‹æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„ Firebase é…ç½®) ---
    // å‰å¾€ Firebase Console -> å°ˆæ¡ˆè¨­å®š -> æ–°å¢ Web æ‡‰ç”¨ç¨‹å¼ç²å–é‡‘é‘°
    const firebaseConfig = {
        apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68",
  authDomain: "jasper-taxi.firebaseapp.com",
  projectId: "jasper-taxi",
  storageBucket: "jasper-taxi.firebasestorage.app",
  messagingSenderId: "558407272439",
  appId: "1:558407272439:web:e48abaae404530a75c90f2",
  measurementId: "G-X8HP1JRZYN",databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userRole = 'passenger';
    let userId = 'user_' + Math.floor(Math.random() * 1000); // æ¨¡æ“¬ç”¨æˆ¶ID

    // --- 2. æ™‚é–“è¨˜éŒ„ç³»çµ± ---
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').innerText = "ç³»çµ±æ ¡æº–æ™‚é–“ï¼š" + now.toLocaleString();
    }
    setInterval(updateClock, 1000);

    function setUserRole(role) {
        userRole = role;
        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('passenger-ui').style.display = role === 'passenger' ? 'block' : 'none';
        document.getElementById('driver-ui').style.display = role === 'driver' ? 'block' : 'none';
    }

    // --- 3. ä¹˜å®¢åŠŸèƒ½ï¼šç™¼é€è¨‚å–® ---
    function submitOrder() {
        const start = document.getElementById('p-start').value;
        const end = document.getElementById('p-end').value;
        if(!start || !end) return alert("è«‹è¼¸å…¥èµ·è¨–é»");

        const orderData = {
            passengerId: userId,
            start: start,
            end: end,
            status: 'waiting', // waiting, accepted, completed
            createTime: new Date().getTime(),
            driverId: '',
            acceptTime: '',
            finishTime: '',
            reviews: { p_star: 0, p_msg: '', d_star: 0, d_msg: '' }
        };

        const newOrderRef = db.ref('orders').push();
        newOrderRef.set(orderData);
        alert("è¨‚å–®å·²ç™¼å‡ºï¼Œè«‹éœå€™å¸æ©Ÿæ¶å–®ï¼");
    }

    // --- 4. å³æ™‚ç›£è½è¨‚å–®æ•¸æ“š ---
    db.ref('orders').on('value', (snapshot) => {
        const orders = snapshot.val();
        renderOrders(orders);
    });

    function renderOrders(orders) {
        const pList = document.getElementById('my-orders');
        const dList = document.getElementById('available-orders');
        pList.innerHTML = '<h4>æˆ‘çš„è¨‚å–®ç‹€æ…‹</h4>';
        dList.innerHTML = '<h4 style="text-align:center;">ğŸ“¡ å³æ™‚æ¶å–®é›·é”</h4>';

        for(let id in orders) {
            const order = orders[id];
            
            // ä¹˜å®¢ç«¯ï¼šé¡¯ç¤ºè‡ªå·±çš„è¨‚å–®
            if(order.passengerId === userId) {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <span class="status-badge ${getStatusClass(order.status)}">${getStatusText(order.status)}</span>
                    <div><b>å¾ï¼š</b>${order.start}</div>
                    <div><b>åˆ°ï¼š</b>${order.end}</div>
                    <div style="font-size:11px; color:#666;">ç™¼å–®æ™‚é–“ï¼š${new Date(order.createTime).toLocaleTimeString()}</div>
                    ${order.driverId ? `<div style="color:#00e676;">ğŸš– å¸æ©Ÿ ${order.driverId} å·²æ¥å–®</div>` : ''}
                    ${order.status === 'completed' ? renderReviewUI(id, 'passenger') : ''}
                `;
                pList.appendChild(card);
            }

            // å¸æ©Ÿç«¯ï¼šé¡¯ç¤ºæ‰€æœ‰ç­‰å¾…ä¸­çš„è¨‚å–®
            if(userRole === 'driver' && order.status === 'waiting') {
                const card = document.createElement('div');
                card.className = 'card order-flash';
                card.innerHTML = `
                    <div style="color:#ff5252; font-weight:bold;">ğŸ”¥ æ–°è¨‚å–®ï¼</div>
                    <div><b>èµ·é»ï¼š</b>${order.start}</div>
                    <div><b>çµ‚é»ï¼š</b>${order.end}</div>
                    <button class="btn-grab" onclick="grabOrder('${id}')">ğŸ“¢ ç«‹å³æ¶å–®</button>
                `;
                dList.appendChild(card);
            } else if (userRole === 'driver' && order.driverId === userId) {
                // å¸æ©Ÿå·²æ¥çš„è¨‚å–®
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <span class="status-badge status-accepted">åŸ·è¡Œä¸­</span>
                    <div><b>å®¢æˆ¶èµ·é»ï¼š</b>${order.start}</div>
                    <button onclick="completeOrder('${id}')">âœ… åˆ°é”ç›®çš„åœ°(çµå–®)</button>
                    ${order.status === 'completed' ? renderReviewUI(id, 'driver') : ''}
                `;
                dList.appendChild(card);
            }
        }
    }

    // --- 5. æ ¸å¿ƒé‚è¼¯ï¼šæ¶å–®èˆ‡çµå–® ---
    function grabOrder(orderId) {
        // ä½¿ç”¨ Firebase transaction ç¢ºä¿åªæœ‰ä¸€å€‹äººèƒ½æ¶åˆ°å–®
        db.ref('orders/' + orderId).transaction((order) => {
            if (order && order.status === 'waiting') {
                order.status = 'accepted';
                order.driverId = userId;
                order.acceptTime = new Date().getTime();
                return order;
            }
            return; // æ¶å–®å¤±æ•—
        }, (error, committed) => {
            if (committed) alert("æ¶å–®æˆåŠŸï¼è«‹ç«‹å³å‰å¾€è¼‰å®¢");
            else alert("å“å‘€ï¼è¢«åˆ¥çš„å¸æ©Ÿæ¶å…ˆäº†");
        });
    }

    function completeOrder(orderId) {
        db.ref('orders/' + orderId).update({
            status: 'completed',
            finishTime: new Date().getTime()
        });
        alert("è¡Œç¨‹çµæŸï¼è¾›è‹¦äº†ã€‚");
    }

    // --- å·¥å…·å‡½å¼ ---
    function getStatusClass(s) {
        if(s === 'waiting') return 'status-waiting';
        if(s === 'accepted') return 'status-accepted';
        return 'status-done';
    }
    function getStatusText(s) {
        if(s === 'waiting') return 'âŒ› ç­‰å¾…æ¶å–®';
        if(s === 'accepted') return 'ğŸš• å¸æ©Ÿè¶•å¾€ä¸­';
        return 'âœ¨ è¡Œç¨‹å®Œæˆ';
    }

    function renderReviewUI(orderId, role) {
        return `
            <div class="rating-box" style="display:block;">
                <p style="font-size:12px; margin:5px 0;">è¡Œç¨‹çµæŸï¼Œè«‹çµ¦äºˆè©•åƒ¹(åƒ…å¾Œå°å¯è¦‹)</p>
                <select id="star-${orderId}" style="width:70px; padding:2px; font-size:12px;">
                    <option value="5">â­â­â­â­â­</option>
                    <option value="4">â­â­â­â­</option>
                    <option value="3">â­â­â­</option>
                    <option value="2">â­â­</option>
                    <option value="1">â­</option>
                </select>
                <input type="text" id="msg-${orderId}" placeholder="å¯«ä¸‹è©•èª..." style="width:100px; padding:2px; font-size:12px;">
                <button onclick="sendReview('${orderId}', '${role}')" style="width:50px; padding:2px; font-size:12px;">é€å‡º</button>
            </div>
        `;
    }

    function sendReview(orderId, role) {
        const star = document.getElementById(`star-${orderId}`).value;
        const msg = document.getElementById(`msg-${orderId}`).value;
        const updateObj = {};
        if(role === 'passenger') {
            updateObj[`orders/${orderId}/reviews/p_star`] = star;
            updateObj[`orders/${orderId}/reviews/p_msg`] = msg;
        } else {
            updateObj[`orders/${orderId}/reviews/d_star`] = star;
            updateObj[`orders/${orderId}/reviews/d_msg`] = msg;
        }
        db.ref().update(updateObj);
        alert("æ„Ÿè¬è©•åƒ¹ï¼");
    }
</script>

</body>
</html>
