<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - 2026 çµ‚æ¥µç¶­å®‰ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        .header { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; cursor: pointer; user-select: none; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-role { flex: 1; padding: 15px; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-role.active { background: #00e676; color: #000; }
        input, textarea { width: 100%; padding: 14px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        .btn-main { width: 100%; padding: 18px; background: #00e676; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .admin-box { display: none; border: 2px solid #00e676; padding: 15px; border-radius: 10px; background: #000; margin-bottom: 20px; }
        .income-banner { background: linear-gradient(135deg, #004d40, #1b5e20); color: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #00e676; text-align: center; }
        #chat-box { height: 250px; overflow-y: auto; background: #000; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; border: 1px solid #333; }
        .msg { max-width: 80%; padding: 10px; border-radius: 10px; font-size: 14px; margin-bottom: 8px; }
        .msg-driver { align-self: flex-end; background: #00e676; color: #000; }
        .msg-passenger { align-self: flex-start; background: #333; color: #fff; }
    </style>
</head>
<body>

    <div class="header" onclick="triggerAdmin()">ğŸš• Jasper æ™ºæ…§åª’åˆç³»çµ± (é–‹ç™¼è€…ç¸½ç«¯)</div>

    <div class="container">
        <div id="admin-ui" class="admin-box">
            <h3 style="color:#00e676;">ğŸ”’ å…¨åŸŸç¶­å®‰èˆ‡å°å¸³ä¸­å¿ƒ</h3>
            <div id="admin-content"></div>
            <button onclick="document.getElementById('admin-ui').style.display='none'" style="width:100%; background:#444; color:#fff; border:none; padding:10px; border-radius:5px; margin-top:10px;">é—œé–‰æ§åˆ¶å°</button>
        </div>

        <div id="main-flow">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-role" id="btn-p" onclick="selectRole('passenger')">ä¹˜å®¢ç«¯</button>
                <button class="btn-role" id="btn-d" onclick="selectRole('driver')">å¸æ©Ÿç«¯</button>
            </div>

            <div id="driver-income-panel" style="display:none;" class="income-banner">
                <small>ğŸ’° ä»Šæ—¥å·²æ’¥æ¬¾ç¸½ç‡Ÿæ”¶</small>
                <div id="today-income-val" style="font-size:24px; font-weight:bold; color:#00e676;">$0</div>
            </div>

            <div id="driver-register" style="display:none;" class="card">
                <h3 style="color:#00e676;">å¸æ©Ÿå¯¦åèªè­‰</h3>
                <input type="text" id="d-name" placeholder="å¸æ©Ÿå§“å">
                <input type="text" id="d-car" placeholder="è»Šç‰Œè™Ÿç¢¼ (å¦‚ ABC-1234)">
                <input type="text" id="d-bank" placeholder="åœ‹æ³°æˆ–è¡—å£ æ”¶æ¬¾å¸³è™Ÿ">
                <label style="font-size:12px; color:#888;">è«‹æ‹ç…§ä¸Šå‚³åŸ·æ¥­ç™»è¨˜è­‰ (åœæ¬Šåˆ¤å®šä¾æ“š)</label>
                <input type="file" id="d-img" accept="image/*">
                <button class="btn-main" onclick="saveDriverProfile()">å„²å­˜èº«åˆ†ä¸¦æ¥å–®</button>
            </div>

            <div id="passenger-ui" style="display:none;">
                <div class="card" style="background:#004d40; border-color:#00e676; padding:15px; text-align:center; font-size:14px;">
                    <b>ğŸ’ Jasper æŒ‡å®šå¸³è™Ÿ (åŒ¯æ¬¾å¾Œç™¼å–®)</b><br>
                    åœ‹æ³°(013): 125506256272 | è¡—å£: 909191462
                </div>
                <div class="card">
                    <input type="tel" id="p-phone" placeholder="ğŸ“ æ‚¨çš„è¯çµ¡é›»è©±">
                    <input type="text" id="p-start" placeholder="ğŸ“ èµ·é» (è©³ç´°åœ°å€)" onblur="calculateFare()">
                    <input type="text" id="p-end" placeholder="ğŸ ç›®çš„åœ°" onblur="calculateFare()">
                    <div id="fare-display" style="display:none; color:#ffeb3b; font-size:13px; margin-bottom:15px;"></div>
                    <input type="number" id="p-fare" placeholder="ğŸ’µ å»ºè­°åŒ¯æ¬¾ç¸½é¡" readonly>
                    <button class="btn-main" onclick="postOrder()">ç™¼é€éœ€æ±‚ (å¾…é–‹ç™¼è€…å°å¸³)</button>
                </div>
            </div>

            <div id="driver-ui" style="display:none;"><div id="order-list">æœå°‹ä¸­...</div></div>

            <div id="chat-section" style="display:none;">
                <div id="match-display" class="card" style="text-align:center; color:#00e676; font-weight:bold;"></div>
                <button style="background:#ff5252; color:white; border:none; padding:10px; width:100%; border-radius:8px; margin-bottom:10px; font-weight:bold;" onclick="openReport()">ğŸš¨ èˆ‰å ±é•è¦è¡Œç‚º</button>
                <button onclick="closeChat()" style="background:#444; color:#fff; width:100%; border:none; padding:12px; border-radius:8px; margin-bottom:10px;">â¬…ï¸ è¿”å›</button>
                <div class="card">
                    <div id="chat-box"></div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="chat-input" placeholder="å°è©±è¨Šæ¯..." style="margin-bottom:0;">
                        <button style="background:#2979ff; border:none; color:white; border-radius:8px; padding:0 20px;" onclick="sendMessage()">ç™¼é€</button>
                    </div>
                </div>
            </div>

            <div id="report-ui" style="display:none;" class="card">
                <h3 style="color:#ff5252;">é•è¦èˆ‰å ±ä¸­å¿ƒ</h3>
                <textarea id="report-reason" rows="4" placeholder="è«‹è©³è¿°ç™¼ç”Ÿç¶“é..."></textarea>
                <input type="file" id="report-img" accept="image/*">
                <button class="btn-main" style="background:#ff5252; color:white;" onclick="submitReport()">æäº¤æ­£å¼ç”³è¨´</button>
                <button onclick="document.getElementById('report-ui').style.display='none'; document.getElementById('chat-section').style.display='block';" style="width:100%; background:none; border:none; color:#888; margin-top:10px;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase é…ç½® (Jasper å°ˆå±¬)
        const firebaseConfig = {
            apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68",
            authDomain: "jasper-taxi.firebaseapp.com",
            projectId: "jasper-taxi",
            storageBucket: "jasper-taxi.firebasestorage.app",
            messagingSenderId: "558407272439",
            appId: "1:558407272439:web:e48abaae404530a75c90f2",
            databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let userId = localStorage.getItem('jasper_user_id') || 'u' + Date.now();
        localStorage.setItem('jasper_user_id', userId);
        let currentRole = '', activeOrderId = null, clickCount = 0;
        const ADMIN_PASS = "Jasper888";

        function triggerAdmin() {
            clickCount++;
            if(clickCount >= 5) {
                const p = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
                if(p === ADMIN_PASS) { document.getElementById('admin-ui').style.display='block'; listenAdmin(); }
                clickCount = 0;
            }
        }

        // ç®¡ç†å“¡å¾Œå°ï¼šå¼·åŒ–åœæ¬Š (è¨­å‚™ ID + è»Šç‰Œ + è­‰ç…§æŒ‡ç´‹)
        function listenAdmin() {
            db.ref('orders').on('value', snap => {
                const content = document.getElementById('admin-content'); content.innerHTML = '';
                snap.forEach(child => {
                    const o = child.val();
                    content.innerHTML += `
                        <div class="card" style="font-size:12px; padding:10px;">
                            <b>ç‹€æ…‹:</b> ${o.status} | <b>é‡‘é¡:</b> $${o.fare}<br>
                            <b>å¸æ©Ÿ:</b> ${o.dName || 'ç„¡'} | <b>è»Šç‰Œ:</b> ${o.dCar || 'ç„¡'}<br>
                            ${o.status==='waiting' ? `<button onclick="updateS('${child.key}', 'pay_confirmed')">âœ… æ”¶æ¬¾ç¢ºèª</button>` : ''}
                            ${o.status==='finished' ? `<button onclick="settle('${child.key}', '${o.dId}', ${o.fare})">ğŸ’° æ’¥æ¬¾ç´¯è¨ˆ</button>` : ''}
                            <button onclick="banD('${o.dId}', '${o.dCar}', '${o.dImgHash || ''}')" style="background:#ff5252; color:white;">ğŸš« åœæ¬Šå¸æ©Ÿ(ä¸‰é‡é–å®š)</button>
                            <button onclick="banP('${o.pPhone}')" style="background:#ffa000; margin-left:5px;">â›” åœæ¬Šä¹˜å®¢</button>
                        </div>`;
                });
            });
        }

        function banD(id, car, hash) {
            if(confirm(`æ°¸ä¹…åœæ¬Šï¼Ÿé–å®šè¨­å‚™ IDã€è»Šç‰Œ(${car})èˆ‡è­‰ä»¶ã€‚`)) {
                if(id) db.ref('blacklist/drivers/' + id).set({ banned: true });
                if(car) db.ref('blacklist/cars/' + car.replace(/\s/g, '')).set({ banned: true });
                if(hash) db.ref('blacklist/hashes/' + hash).set({ banned: true });
                alert("å¸æ©Ÿä¸‰æ–¹è³‡è¨Šå·²é–å®šã€‚");
            }
        }
        function banP(phone) { if(phone && confirm(`åœæ¬Šé›»è©± ${phone}ï¼Ÿ`)) db.ref('blacklist/passengers/' + phone).set({time: Date.now()}); }
        function updateS(id, s) { db.ref('orders/' + id).update({ status: s }); }
        function settle(id, dId, f) { 
            const today = new Date().toISOString().split('T')[0];
            db.ref(`income/${dId}/${today}`).transaction(c => (c || 0) + Number(f));
            db.ref('orders/' + id).update({ status: 'settled' });
        }

        // æ ¸å¿ƒæª¢æŸ¥ï¼šé˜²æ­¢åœæ¬Šè€…ç™»å…¥
        function checkDriverBan(profile, callback) {
            const car = (profile.car || "").replace(/\s/g, '');
            const imgHash = (profile.img || "").substring(0, 100);
            db.ref('blacklist').once('value', snap => {
                const b = snap.val() || {};
                const isBanned = (b.drivers && b.drivers[userId]) || 
                                 (b.cars && b.cars[car]) || 
                                 (b.hashes && b.hashes[imgHash]);
                if(isBanned) alert("âš ï¸ æ‚¨çš„å¸³è™Ÿã€è»Šç‰Œæˆ–è­‰ç…§å·²è¢«ç³»çµ±æ°¸ä¹…å°é–ã€‚");
                else callback();
            });
        }

        function selectRole(role) {
            currentRole = role;
            if(role === 'driver') {
                const p = JSON.parse(localStorage.getItem('driver_profile') || '{}');
                if(!p.name) { 
                    document.getElementById('driver-register').style.display = 'block';
                    document.getElementById('passenger-ui').style.display = 'none';
                } else {
                    checkDriverBan(p, () => {
                        document.getElementById('driver-income-panel').style.display = 'block';
                        document.getElementById('driver-ui').style.display = 'block';
                        document.getElementById('driver-register').style.display = 'none';
                        listenOrders(); updateIncome();
                    });
                }
            } else {
                document.getElementById('driver-income-panel').style.display = 'none';
                document.getElementById('passenger-ui').style.display = 'block';
                document.getElementById('driver-ui').style.display = 'none';
            }
        }

        function calculateFare() {
            const start = document.getElementById('p-start').value, end = document.getElementById('p-end').value;
            if(!start || !end) return;
            const now = new Date(), hour = now.getHours(), time = now.getTime();
            // æ˜¥ç¯€ï¼š2/11 00:00 - 2/22 24:00 (JavaScript æœˆä»½å¾ 0 é–‹å§‹ï¼Œ1 ä»£è¡¨ 2 æœˆ)
            const springStart = new Date(2026, 1, 11, 0).getTime(), springEnd = new Date(2026, 1, 22, 23, 59, 59).getTime();
            let base = 85, km = 5.0 * 25, traf = 8 * 5, sur = 0, note = "ä¸€èˆ¬æ™‚æ®µ";
            if(time >= springStart && time <= springEnd) { sur = 30; note = "ğŸ§§ 2026 æ˜¥ç¯€åŠ æˆ (+30)"; }
            else if(hour >= 23 || hour <= 6) { sur = 20; note = "ğŸŒ™ å¤œé–“åŠ æˆ (+20)"; }
            const total = Math.round(base + km + traf + sur);
            document.getElementById('fare-display').style.display = 'block';
            document.getElementById('fare-display').innerHTML = `æ™‚æ®µï¼š${note}<br>é è¨ˆåŒ¯æ¬¾ç¸½é¡ï¼š<b>$${total}</b>`;
            document.getElementById('p-fare').value = total;
        }

        function saveDriverProfile() {
            const n = document.getElementById('d-name').value, c = document.getElementById('d-car').value;
            const b = document.getElementById('d-bank').value, f = document.getElementById('d-img').files[0];
            if(!n || !c || !f || !b) return alert("è³‡è¨Šä¸å…¨");
            const r = new FileReader(); r.onload = (e) => {
                const prof = {name:n, car:c, bank:b, img:e.target.result};
                localStorage.setItem('driver_profile', JSON.stringify(prof));
                selectRole('driver');
            }; r.readAsDataURL(f);
        }

        function postOrder() {
            const ph = document.getElementById('p-phone').value, fare = document.getElementById('p-fare').value;
            const s = document.getElementById('p-start').value, e = document.getElementById('p-end').value;
            if(!ph || !fare || !s || !e) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            db.ref('blacklist/passengers/' + ph).once('value', snap => {
                if(snap.exists()) return alert("âš ï¸ æ­¤é›»è©±å·²è¢«åˆ—å…¥é»‘åå–®ã€‚");
                const ref = db.ref('orders').push(); activeOrderId = ref.key;
                ref.set({ pPhone: ph, fare, start: s, end: e, status: 'waiting', pId: userId, createTime: Date.now() });
                loadChat(activeOrderId);
            });
        }

        function listenOrders() {
            db.ref('orders').on('value', snap => {
                const list = document.getElementById('order-list'); list.innerHTML = '';
                snap.forEach(child => {
                    const o = child.val();
                    if(o.status === 'pay_confirmed') {
                        list.innerHTML += `<div class="card" style="padding:15px;">ğŸ“ ${o.start} â” ${o.end}<br>ğŸ’µ ç¸½é¡: $${o.fare}<br><button class="btn-main" onclick="acceptOrder('${child.key}')">å·²å°å¸³ï¼Œæˆ‘è¦æ¶å–®</button></div>`;
                    }
                });
            });
        }

        function acceptOrder(id) {
            const p = JSON.parse(localStorage.getItem('driver_profile'));
            db.ref('orders/' + id).transaction(o => {
                if(o && o.status === 'pay_confirmed') { 
                    o.status = 'accepted'; o.dId = userId; o.dName = p.name; o.dCar = p.car;
                    o.dImgHash = p.img.substring(0, 100); 
                    return o; 
                }
            }, (err, com) => { if(com) loadChat(id); });
        }
        function loadChat(id) { activeOrderId = id; document.getElementById('main-flow').style.display='none'; document.getElementById('chat-section').style.display='block'; listenChat(id); }
        function listenChat(id) {
            db.ref('orders/' + id).on('value', snap => {
                const o = snap.val(); if(!o) return;
                const d = document.getElementById('match-display');
                if(currentRole === 'driver') {
                    const nav = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(o.start)}`;
                    d.innerHTML = `é ä¼°é¡åº¦: $${o.fare}<br><button onclick="window.open('${nav}')" style="background:#2979ff; color:white; border:none; padding:8px; border-radius:5px; margin-top:5px;">ğŸ“ ä¸€éµå°èˆª</button>`;
                    if(o.status === 'accepted') d.innerHTML += `<br><button onclick="finishTrip()" style="background:#00e676; border:none; padding:10px; border-radius:5px; margin-top:5px; color:#000;">å®Œæˆè¡Œç¨‹</button>`;
                } else d.innerHTML = `æ”¯ä»˜é¡: $${o.fare} | ${o.status==='waiting'?'ç­‰å¾…é–‹ç™¼è€…å°å¸³ä¸­':'å¸æ©Ÿ:'+o.dName}`;
            });
            db.ref('messages/' + id).on('value', snap => {
                const box = document.getElementById('chat-box'); box.innerHTML = '';
                snap.forEach(m => { const msg = m.val(); box.innerHTML += `<div class="msg msg-${msg.role}">${msg.text}</div>`; });
                box.scrollTop = box.scrollHeight;
            });
        }
        function updateIncome() { const t = new Date().toISOString().split('T')[0]; db.ref(`income/${userId}/${t}`).on('value', snap => document.getElementById('today-income-val').innerText = `$${snap.val() || 0}`); }
        function finishTrip() { db.ref('orders/' + activeOrderId).update({ status: 'finished' }); alert("è¡Œç¨‹çµæŸï¼Œè«‹å‘ŠçŸ¥é–‹ç™¼è€…æ’¥æ¬¾ã€‚"); }
        function sendMessage() { const t = document.getElementById('chat-input').value; if(t) { db.ref('messages/' + activeOrderId).push({ role: currentRole, text: t, time: Date.now() }); document.getElementById('chat-input').value = ''; } }
        function openReport() { document.getElementById('chat-section').style.display = 'none'; document.getElementById('report-ui').style.display = 'block'; }
        function submitReport() {
            const r = document.getElementById('report-reason').value, f = document.getElementById('report-img').files[0];
            if(!r || !f) return alert("è«‹é™„è­‰ç‰©ç…§ç‰‡");
            const reader = new FileReader(); reader.onload = (e) => {
                db.ref('complaints').push({ from: userId, reason: r, img: e.target.result, time: Date.now() });
                alert("ç”³è¨´å·²æäº¤ã€‚"); document.getElementById('report-ui').style.display='none'; document.getElementById('chat-section').style.display='block';
            }; reader.readAsDataURL(f);
        }
        function closeChat() { document.getElementById('main-flow').style.display='block'; document.getElementById('chat-section').style.display='none'; }
    </script>
</body>
</html>
