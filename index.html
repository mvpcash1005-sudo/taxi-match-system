<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - å…¨æ–¹ä½ç›£æ§ç¸½ç«¯</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        .header { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; cursor: pointer; user-select: none; }
        .container { padding: 15px; max-width: 1000px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-role { flex: 1; padding: 15px; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-role.active { background: #00e676; color: #000; }
        input, select { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        .btn-main { width: 100%; padding: 15px; background: #00e676; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-line { background: #00c300; color: white; margin-top: 10px; }
        
        /* ç®¡ç†å“¡ä»‹é¢ */
        .admin-box { display: none; margin-top: 10px; border: 2px solid #00e676; padding: 10px; border-radius: 12px; background: #000; }
        .admin-nav { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #333; margin-bottom: 15px; }
        .tab-btn { padding: 8px 12px; background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 13px; }
        .tab-btn.active { background: #00e676; color: #000; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; background: #111; }
        th, td { border: 1px solid #333; padding: 10px; text-align: left; }
        th { background: #222; color: #00e676; }
        .img-thumb { width: 40px; height: 40px; object-fit: cover; border: 1px solid #555; margin-right: 5px; cursor: pointer; }
        
        /* è¨‚å–®è¿½è¹¤å€ */
        #order-tracking { background: #004d40; border: 1px solid #00e676; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: none; }
        
        /* ç…§ç‰‡é è¦½èˆ‡ä¸Šå‚³ */
        .upload-group { margin-bottom: 15px; }
        .upload-label { font-size: 12px; color: #00e676; display: block; margin-bottom: 5px; }
        .preview-box { width: 100%; height: 100px; background: #333; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .preview-box img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div class="header" onclick="triggerAdmin()">ğŸš• Jasper æ™ºæ…§åª’åˆç®¡ç†ç¸½ç«¯</div>

    <div class="container">
        <div id="admin-ui" class="admin-box">
            <div class="admin-nav">
                <button class="tab-btn active" id="tab-pay" onclick="switchTab('p-orders')">ğŸ’° åŒ¯æ¬¾æ”¾å–®</button>
                <button class="tab-btn" id="tab-verify" onclick="switchTab('p-verify')">ğŸ“„ å¸æ©Ÿå¯©æ ¸</button>
                <button class="tab-btn" id="tab-member" onclick="switchTab('p-members')">ğŸ‘¥ å¸æ©Ÿæˆå“¡åˆ—è¡¨</button>
                <button onclick="closeAdmin()" style="margin-left: auto; border:none; background:none; color:red;">é—œé–‰</button>
            </div>
            <div id="admin-content"></div>
        </div>

        <div id="main-flow">
            <div id="order-tracking">
                <h3 style="margin-top:0; font-size:16px;">ğŸ” æ‚¨çš„è¨‚å–®é€²åº¦</h3>
                <div id="tracking-content">è®€å–ä¸­...</div>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-role active" id="btn-p" onclick="selectRole('passenger')">ä¹˜å®¢ç«¯</button>
                <button class="btn-role" id="btn-d" onclick="selectRole('driver')">å¸æ©Ÿç«¯</button>
            </div>

            <div id="passenger-ui">
                <div class="card" style="background: #004d40; text-align: center; font-size: 14px; border-color: #00e676;">
                    <b>ğŸ’ Jasper æ”¶æ¬¾ (å…ˆåŒ¯æ¬¾å¾Œæ”¾å–®)</b><br>
                    åœ‹æ³°(013): 125506256272 | è¡—å£: 909191462
                </div>
                <div class="card">
                    <label style="font-size:12px; color:#00e676;">ğŸ“… é ç´„ä¸Šè»Šæ™‚é–“</label>
                    <input type="datetime-local" id="p-book-time">
                    <input type="tel" id="p-phone" placeholder="ğŸ“ è¯çµ¡é›»è©±">
                    <input type="text" id="p-start" placeholder="ğŸ“ èµ·é»">
                    <input type="text" id="p-end" placeholder="ğŸ ç›®çš„åœ°">
                    <input type="number" id="p-fare" placeholder="ğŸ’µ å»ºè­°åŒ¯æ¬¾ç¸½é¡ (ç³»çµ±é ä¼°+åŠ æˆ)">
                    <button class="btn-main" onclick="postOrder()">ç™¼é€è¨‚å–®ä¸¦æ ¸å¸³</button>
                </div>
            </div>

            <div id="driver-register" style="display:none;" class="card">
                <h3 style="color:#00e676; margin-top:0;">å¸æ©Ÿå¯¦åèªè­‰</h3>
                <input type="text" id="d-name" placeholder="å§“å">
                <input type="tel" id="d-phone" placeholder="é›»è©±è™Ÿç¢¼">
                <input type="text" id="d-car" placeholder="è»Šç‰Œè™Ÿç¢¼">
                <input type="text" id="d-bank" placeholder="æ”¶æ¬¾å¸³è™Ÿ (åœ‹æ³°/è¡—å£)">
                
                <div class="upload-group">
                    <span class="upload-label">ğŸ“¸ è»Šç‰Œç…§ç‰‡</span>
                    <input type="file" accept="image/*" onchange="previewImg(this, 'pre-car')">
                    <div class="preview-box" id="pre-car">é è¦½</div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div class="upload-group" style="flex:1;">
                        <span class="upload-label">ğŸ“¸ èº«åˆ†è­‰ (æ­£)</span>
                        <input type="file" accept="image/*" onchange="previewImg(this, 'pre-id-f')">
                        <div class="preview-box" id="pre-id-f">é è¦½</div>
                    </div>
                    <div class="upload-group" style="flex:1;">
                        <span class="upload-label">ğŸ“¸ èº«åˆ†è­‰ (å)</span>
                        <input type="file" accept="image/*" onchange="previewImg(this, 'pre-id-b')">
                        <div class="preview-box" id="pre-id-b">é è¦½</div>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div class="upload-group" style="flex:1;">
                        <span class="upload-label">ğŸ“¸ åŸ·æ¥­è­‰ (æ­£)</span>
                        <input type="file" accept="image/*" onchange="previewImg(this, 'pre-lic-f')">
                        <div class="preview-box" id="pre-lic-f">é è¦½</div>
                    </div>
                    <div class="upload-group" style="flex:1;">
                        <span class="upload-label">ğŸ“¸ åŸ·æ¥­è­‰ (å)</span>
                        <input type="file" accept="image/*" onchange="previewImg(this, 'pre-lic-b')">
                        <div class="preview-box" id="pre-lic-b">é è¦½</div>
                    </div>
                </div>

                <button class="btn-main" onclick="saveDriverProfile()">æäº¤è³‡æ–™ä¸¦ç­‰å¾…å¯©æ ¸</button>
                <button class="btn-main btn-line" onclick="window.open('https://line.me/ti/p/~love_ice_boy')">ä¸€éµåŠ å…¥ Jasper è€å¸« Line</button>
            </div>

            <div id="driver-ui" style="display:none;"><div id="order-list">æœå°‹ä¸­...</div></div>
        </div>
    </div>

    <script>
        // Firebase Config (è«‹ç¢ºä¿æ­¤è³‡è¨Šæ­£ç¢º)
        const firebaseConfig = {
            apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68",
            databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ADMIN_PASS = "Jasper888";
        let userId = localStorage.getItem('jasper_user_id') || 'u' + Date.now();
        localStorage.setItem('jasper_user_id', userId);
        let currentRole = 'passenger', adminClickCount = 0;

        // --- ä¿®æ­£å¾Œçš„ç®¡ç†å“¡è§¸ç™¼é‚è¼¯ ---
        function triggerAdmin() {
            adminClickCount++;
            if(adminClickCount >= 5) {
                const p = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡æˆæ¬Šå¯†ç¢¼ï¼š");
                if(p === ADMIN_PASS) {
                    document.getElementById('admin-ui').style.display = 'block';
                    switchTab('p-orders');
                }
                adminClickCount = 0;
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(tab==='p-orders') { document.getElementById('tab-pay').classList.add('active'); loadAdminOrders(); }
            if(tab==='p-verify') { document.getElementById('tab-verify').classList.add('active'); loadAdminVerify(); }
            if(tab==='p-members') { document.getElementById('tab-member').classList.add('active'); loadAdminMembers(); }
        }

        // --- ç®¡ç†å“¡ï¼šå¾…æ ¸å¸³æ¸…å–® (ä¿®æ­£ undefined å•é¡Œ) ---
        function loadAdminOrders() {
            db.ref('orders').on('value', snap => {
                let html = '<h4>ğŸ’° å¾…æ ¸å¸³æ”¾å–®æ¸…å–®</h4><table><tr><th>é ç´„æ—¥æœŸ</th><th>ä¹˜å®¢é›»è©±</th><th>è·¯ç·š</th><th>é‡‘é¡</th><th>æ“ä½œ</th></tr>';
                snap.forEach(c => {
                    const o = c.val();
                    if(o.status === 'waiting') {
                        // è™•ç†æ™‚é–“æ ¼å¼
                        const dateObj = new Date(o.createTime);
                        const dateStr = `${dateObj.getMonth()+1}/${dateObj.getDate()} ${dateObj.getHours()}:${dateObj.getMinutes().toString().padStart(2,'0')}`;
                        html += `<tr>
                            <td>${dateStr}</td>
                            <td>${o.pPhone || 'åŒ¿å'}</td>
                            <td>${o.start || 'ç„¡èµ·é»'}â”<br>${o.end || 'ç„¡çµ‚é»'}</td>
                            <td>$${o.fare || '0'}</td>
                            <td><button onclick="approveOrder('${c.key}')">ç¢ºèªæ”¶æ¬¾æ”¾å–®</button></td>
                        </tr>`;
                    }
                });
                document.getElementById('admin-content').innerHTML = html + '</table>';
            });
        }

        // --- ç®¡ç†å“¡ï¼šæˆå“¡åˆ—è¡¨ (ä¿®æ­£ç…§ç‰‡é»æ“Šæ”¾å¤§) ---
        function loadAdminMembers() {
            db.ref('drivers').on('value', snap => {
                let html = '<h4>ğŸ‘¥ å¸æ©Ÿæˆå“¡å…¨è³‡æ–™åº« (æ°¸ä¹…)</h4><table><tr><th>å§“å/æ‰‹æ©Ÿ</th><th>è»Šç‰Œ</th><th>å¸³è™Ÿ</th><th>å®Œæ•´è­‰ä»¶åº« (é»æ“Šåœ–ç‰‡çœ‹å¤§åœ–)</th></tr>';
                snap.forEach(c => {
                    const d = c.val();
                    html += `<tr>
                        <td>${d.name}<br>${d.phone || 'ç„¡é›»è©±'}</td>
                        <td>${d.car}</td>
                        <td>${d.bank}</td>
                        <td>
                            <img class="img-thumb" src="${d.imgCar}" onclick="window.open(this.src)">
                            <img class="img-thumb" src="${d.idF}" onclick="window.open(this.src)">
                            <img class="img-thumb" src="${d.idB}" onclick="window.open(this.src)">
                            <img class="img-thumb" src="${d.licF}" onclick="window.open(this.src)">
                            <img class="img-thumb" src="${d.licB}" onclick="window.open(this.src)">
                        </td>
                    </tr>`;
                });
                document.getElementById('admin-content').innerHTML = html + '</table>';
            });
        }

        // --- ä¹˜å®¢ç«¯ï¼šå³æ™‚è¿½è¹¤è¨‚å–® (æ–°å¢) ---
        function listenMyOrder() {
            db.ref('orders').orderByChild('pId').equalTo(userId).on('value', snap => {
                const trackBox = document.getElementById('order-tracking');
                const content = document.getElementById('tracking-content');
                if(snap.exists()) {
                    trackBox.style.display = 'block';
                    snap.forEach(c => {
                        const o = c.val();
                        let statusText = "";
                        if(o.status === 'waiting') statusText = "â³ ç­‰å¾… Jasper è€å¸«ç¢ºèªåŒ¯æ¬¾ä¸­...";
                        if(o.status === 'pay_confirmed') statusText = "âœ… Jasper è€å¸«å·²æ ¸å¸³ï¼Œæ­£ç­‰å¾…å¸æ©Ÿæ¶å–®...";
                        if(o.status === 'accepted') statusText = `ğŸš– å¸æ©Ÿ ${o.dName} å·²æ¥å–®ï¼å‰å¾€ä¸­...`;
                        content.innerHTML = `è¨‚å–®ï¼š${o.start} â” ${o.end}<br>ç‹€æ…‹ï¼š<b>${statusText}</b>`;
                    });
                } else {
                    trackBox.style.display = 'none';
                }
            });
        }

        // --- ç™¼å–®é‚è¼¯ ---
        function postOrder() {
            const f = document.getElementById('p-fare').value;
            const ph = document.getElementById('p-phone').value;
            const s = document.getElementById('p-start').value;
            const e = document.getElementById('p-end').value;
            const b = document.getElementById('p-book-time').value;
            if(!f || !ph || !s || !e) return alert("è«‹å¡«å¯«å®Œæ•´å«è»Šè³‡è¨Š");
            
            db.ref('orders').push().set({
                pPhone: ph, fare: f, start: s, end: e, bookTime: b,
                status: 'waiting', pId: userId, createTime: Date.now()
            }).then(() => {
                alert("è¨‚å–®å·²ç™¼é€ï¼è«‹ç¢ºèªå·²å®ŒæˆåŒ¯æ¬¾ã€‚");
                listenMyOrder();
            });
        }

        // --- å¸æ©Ÿè¨»å†Šèˆ‡ç…§ç‰‡è™•ç† ---
        function previewImg(input, tid) {
            const f = input.files[0]; if(f) {
                const r = new FileReader(); r.onload = (e) => document.getElementById(tid).innerHTML = `<img src="${e.target.result}">`;
                r.readAsDataURL(f);
            }
        }

        function saveDriverProfile() {
            const name = document.getElementById('d-name').value;
            const phone = document.getElementById('d-phone').value;
            const car = document.getElementById('d-car').value;
            const bank = document.getElementById('d-bank').value;
            
            // æŠ“å–å…­å¼µé è¦½åœ–çš„ Base64
            const imgCar = document.querySelector('#pre-car img')?.src;
            const idF = document.querySelector('#pre-id-f img')?.src;
            const idB = document.querySelector('#pre-id-b img')?.src;
            const licF = document.querySelector('#pre-lic-f img')?.src;
            const licB = document.querySelector('#pre-lic-b img')?.src;

            if(!name || !imgCar || !idF || !idB || !licF || !licB) return alert("è«‹å¡«å¯«æ‰€æœ‰è³‡æ–™ä¸¦ä¸Šå‚³å…­å¼µè­‰ä»¶ç…§");

            db.ref('drivers/' + userId).set({
                name, phone, car, bank, imgCar, idF, idB, licF, licB,
                status: 'pending', userId: userId
            }).then(() => {
                alert("è³‡æ–™å·²æäº¤å¯©æ ¸ï¼");
                location.reload();
            });
        }

        // è¼”åŠ©å‡½æ•¸
        function approveOrder(id) { db.ref('orders/'+id).update({status: 'pay_confirmed'}); alert('æ”¾å–®æˆåŠŸï¼'); }
        function selectRole(r) {
            currentRole = r;
            document.getElementById('btn-p').className = r==='passenger'?'btn-role active':'btn-role';
            document.getElementById('btn-d').className = r==='driver'?'btn-role active':'btn-role';
            document.getElementById('passenger-ui').style.display = r==='passenger'?'block':'none';
            if(r === 'driver') {
                db.ref('drivers/'+userId).once('value', s => {
                    const d = s.val();
                    if(!d) document.getElementById('driver-register').style.display = 'block';
                    else if(d.status==='approved') document.getElementById('driver-ui').style.display = 'block';
                    else alert("æ‚¨çš„èº«åˆ†å¯©æ ¸ä¸­ã€‚");
                });
            } else {
                document.getElementById('driver-register').style.display = 'none';
                document.getElementById('driver-ui').style.display = 'none';
                listenMyOrder();
            }
        }
        function closeAdmin() { document.getElementById('admin-ui').style.display='none'; }
        window.onload = function() { listenMyOrder(); };
    </script>
</body>
</html>
