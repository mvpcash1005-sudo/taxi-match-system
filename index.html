<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - å…¨æ–¹ä½ç›£æ§ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        h2 { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; margin:0; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); position: relative; }
        .btn-role { flex: 1; padding: 15px; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-role.active { background: #00e676; color: #000; }
        input { width: 100%; padding: 14px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 18px; background: #00e676; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 18px; }
        .btn-reject { width: 100%; padding: 15px; background: #ff5252; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 15px; }
        .time-badge { position: absolute; top: 10px; right: 10px; font-size: 11px; color: #00e676; }
        #chat-box { height: 280px; overflow-y: auto; background: #121212; border: 1px solid #333; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 10px; font-size: 14px; word-break: break-all; }
        .msg-driver { align-self: flex-end; background: #00e676; color: #000; }
        .msg-passenger { align-self: flex-start; background: #333; color: #fff; }
        .msg-system { align-self: center; background: #444; color: #ffeb3b; font-size: 11px; padding: 4px 10px; border-radius: 5px; text-align: center; width: 90%; }
        .history-item { font-size: 13px; color: #bbb; border-bottom: 1px solid #333; padding: 12px 0; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸš• Jasper æ™ºæ…§åª’åˆç³»çµ±</h2>

    <div class="container">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn-role" id="btn-p" onclick="selectRole('passenger')">æˆ‘æ˜¯ä¹˜å®¢</button>
            <button class="btn-role" id="btn-d" onclick="selectRole('driver')">æˆ‘æ˜¯å¸æ©Ÿ</button>
        </div>

        <div id="passenger-ui" style="display:none;">
            <div id="dist-alert-p"></div>
            <div class="card">
                <input type="text" id="p-start" placeholder="ğŸ“ è¼¸å…¥èµ·é»">
                <input type="text" id="p-end" placeholder="ğŸ è¼¸å…¥ç›®çš„åœ°">
                <button class="btn-main" onclick="postOrder()">ç™¼é€æ¶å–®éœ€æ±‚</button>
            </div>
            <div style="color: #888; font-size: 14px; margin-top:20px;">ğŸ“… æˆ‘çš„æ­·å²ç´€éŒ„</div>
            <div id="p-history-list"></div>
        </div>

        <div id="driver-ui" style="display:none;">
            <div style="font-size: 12px; color: #888; margin-bottom:10px;">ğŸ“¡ å¾…æ¥è¨‚å–® (å³æ™‚æ›´æ–°)</div>
            <div id="order-list"></div>
            <div style="color: #888; font-size: 14px; margin-top:20px;">ğŸ“‹ æ­·å²æ¥å–®ç´€éŒ„</div>
            <div id="d-history-list"></div>
        </div>

        <div id="chat-section" style="display:none;">
            <div id="p-controls" style="display:none;">
                <button class="btn-reject" onclick="rejectOrder()">âŒ å¸æ©Ÿä¸åˆé©ï¼Œé‡å•Ÿè¨‚å–®</button>
            </div>
            
            <button onclick="closeChat()" style="background:#444; color:#fff; width:100%; border:none; padding:12px; border-radius:8px; margin-bottom:10px; font-weight:bold;">â¬…ï¸ è¿”å›æ¸…å–®</button>
            
            <div class="card">
                <div id="chat-box"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." style="margin-bottom:0;">
                    <button style="background:#2979ff; border:none; color:white; border-radius:8px; padding:0 20px; font-weight:bold;" onclick="sendMessage()">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config (ä¿æŒä¸è®Š)
        const firebaseConfig = {
            apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68",
            authDomain: "jasper-taxi.firebaseapp.com",
            projectId: "jasper-taxi",
            storageBucket: "jasper-taxi.firebasestorage.app",
            messagingSenderId: "558407272439",
            appId: "1:558407272439:web:e48abaae404530a75c90f2",
            measurementId: "G-X8HP1JRZYN",
            databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let userId = localStorage.getItem('jasper_user_id') || 'u' + Date.now();
        localStorage.setItem('jasper_user_id', userId);

        let currentRole = '', activeOrderId = null, userLat = null, userLon = null;

        navigator.geolocation.getCurrentPosition(pos => {
            userLat = pos.coords.latitude; userLon = pos.coords.longitude;
        }, null, { enableHighAccuracy: true });

        window.onload = () => {
            const savedRole = localStorage.getItem('jasper_last_role');
            if(savedRole) selectRole(savedRole);
        };

        function selectRole(role) {
            currentRole = role;
            localStorage.setItem('jasper_last_role', role);
            document.querySelectorAll('.btn-role').forEach(b => b.classList.remove('active'));
            document.getElementById(role === 'passenger' ? 'btn-p' : 'btn-d').classList.add('active');
            
            document.getElementById('passenger-ui').style.display = role === 'passenger' ? 'block' : 'none';
            document.getElementById('driver-ui').style.display = role === 'driver' ? 'block' : 'none';
            document.getElementById('chat-section').style.display = 'none';
            
            if(role === 'driver') listenForOrders();
            renderHistory();
        }

        // ç™¼é€éœ€æ±‚
        function postOrder() {
            const start = document.getElementById('p-start').value;
            const end = document.getElementById('p-end').value;
            if(!start || !end) return alert("è«‹è¼¸å…¥å®Œæ•´èµ·è¿„é»");
            
            const newRef = db.ref('orders').push();
            const orderId = newRef.key;
            newRef.set({
                start, end, status: 'waiting',
                pId: userId, pLat: userLat, pLon: userLon,
                createTime: Date.now()
            });
            loadActiveOrder(orderId);
        }

        // ç›£è½è¨‚å–® (å¸æ©Ÿç«¯)
        function listenForOrders() {
            db.ref('orders').on('value', snap => {
                const orders = snap.val();
                const list = document.getElementById('order-list');
                list.innerHTML = '';
                for(let id in orders) {
                    const o = orders[id];
                    if(o.status === 'waiting') {
                        const timeStr = new Date(o.createTime).toLocaleTimeString();
                        list.innerHTML += `
                            <div class="card">
                                <span class="time-badge">ğŸ•’ ${timeStr}</span>
                                <div style="color:#00e676; font-size:12px; margin-bottom:8px;">â— ç­‰å¾…å¸æ©Ÿä¸­</div>
                                ğŸ“ ${o.start}<br>ğŸ ${o.end}<br>
                                <button class="btn-main" style="margin-top:10px;" onclick="acceptOrder('${id}')">ç«‹å³æ¶å–®</button>
                            </div>`;
                    }
                }
            });
        }

        // æ¶å–®é‚è¼¯
        function acceptOrder(id) {
            db.ref('orders/' + id).transaction(order => {
                if(order && order.status === 'waiting') {
                    order.status = 'accepted';
                    order.dId = userId; order.dLat = userLat; order.dLon = userLon;
                    return order;
                }
            }, (err, committed) => {
                if(committed) {
                    db.ref('messages/' + id).push({ role: 'system', text: "å¸æ©Ÿå·²æ¶å–®æˆåŠŸï¼Œè«‹é–‹å§‹æºé€šä½ç½®ã€‚", time: Date.now() });
                    loadActiveOrder(id);
                } else alert("æ­¤å–®å·²è¢«æ¶èµ°ï¼");
            });
        }

        // é€²å…¥å°è©±è¦–çª—
        function loadActiveOrder(orderId) {
            activeOrderId = orderId;
            document.getElementById('passenger-ui').style.display = 'none';
            document.getElementById('driver-ui').style.display = 'none';
            document.getElementById('chat-section').style.display = 'block';
            
            // å¦‚æœæ˜¯ä¹˜å®¢ï¼Œé¡¯ç¤ºæ§ç®¡æŒ‰éˆ•
            document.getElementById('p-controls').style.display = (currentRole === 'passenger') ? 'block' : 'none';
            
            listenForChat(orderId);
        }

        // ç›£è½å°è©±èˆ‡ç‹€æ…‹
        function listenForChat(orderId) {
            // ç›£è½è¨‚å–®ç‹€æ…‹è®Šæ›´
            db.ref('orders/' + orderId).on('value', snap => {
                const o = snap.val();
                if(!o) return;
                
                // å¸æ©Ÿè¢«ä¹˜å®¢è¸¢å‡ºçš„é‚è¼¯
                if(o.status === 'waiting' && currentRole === 'driver' && activeOrderId === orderId) {
                    alert("ä¹˜å®¢å·²é‡æ–°é–‹æ”¾è¨‚å–®ï¼Œå°è©±å·²é—œé–‰ã€‚");
                    closeChat();
                }
            });

            // ç›£è½è¨Šæ¯
            db.ref('messages/' + orderId).on('value', snap => {
                const msgs = snap.val();
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                for(let m in msgs) {
                    const msg = msgs[m];
                    const div = document.createElement('div');
                    div.className = msg.role === 'system' ? 'msg-system' : `msg msg-${msg.role}`;
                    div.innerText = msg.text;
                    box.appendChild(div);
                }
                box.scrollTop = box.scrollHeight;
            });
        }

        // ä¹˜å®¢é‡æ–°é–‹æ”¾è¨‚å–®
        function rejectOrder() {
            if(!confirm("ç¢ºå®šè¦å°‡è¨‚å–®é‡æ–°é–‹æ”¾çµ¦å…¨å€å¸æ©Ÿæ¶å–®å—ï¼Ÿç›®å‰çš„å¸æ©Ÿå°‡æœƒè¢«é€€å‡ºã€‚")) return;
            
            db.ref('messages/' + activeOrderId).push({ 
                role: 'system', 
                text: "âŒ ä¹˜å®¢é‡æ–°ç™¼å–®ï¼Œè¨‚å–®å·²å›åˆ°å¤§å»³ç­‰å¾…æ–°å¸æ©Ÿã€‚", 
                time: Date.now() 
            });

            db.ref('orders/' + activeOrderId).update({
                status: 'waiting',
                dId: null,
                dLat: null,
                dLon: null
            }).then(() => {
                alert("å·²æˆåŠŸé‡æ–°ç™¼å–®ï¼");
                closeChat();
            });
        }

        function sendMessage() {
            const text = document.getElementById('chat-input').value;
            if(text && activeOrderId) {
                db.ref('messages/' + activeOrderId).push({ role: currentRole, text: text, time: Date.now() });
                document.getElementById('chat-input').value = '';
            }
        }

        function closeChat() {
            activeOrderId = null;
            selectRole(currentRole);
        }

        function renderHistory() {
            db.ref('orders').limitToLast(10).once('value', snap => {
                const orders = snap.val();
                const pList = document.getElementById('p-history-list');
                const dList = document.getElementById('d-history-list');
                pList.innerHTML = ''; dList.innerHTML = '';
                for(let id in orders) {
                    const o = orders[id];
                    const time = new Date(o.createTime).toLocaleString();
                    const item = `<div class="history-item" onclick="loadActiveOrder('${id}')">ğŸ•’ ${time}<br>ğŸ“ ${o.start} â” ${o.end} (${o.status})</div>`;
                    if(o.pId === userId) pList.innerHTML += item;
                    if(o.dId === userId) dList.innerHTML += item;
                }
            });
        }
    </script>
</body>
</html>
