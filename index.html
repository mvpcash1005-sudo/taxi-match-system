<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - çµ‚æ¥µç¶­å®‰è²¡å‹™ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        #browser-notice { display: none; background: #ffeb3b; color: #000; padding: 12px; text-align: center; font-size: 14px; font-weight: bold; position: sticky; top: 0; z-index: 9999; }
        .header { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; cursor: pointer; user-select: none; }
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; }
        .btn-role { flex: 1; padding: 15px; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-role.active { background: #00e676; color: #000; }
        input, select, textarea { width: 100%; padding: 14px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        .btn-main { width: 100%; padding: 18px; background: #00e676; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .admin-box { display: none; margin-top: 20px; }
        .tab-btn { padding: 10px 20px; background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px; }
        .tab-btn.active { background: #00e676; color: #000; }
        .info-banner { background: linear-gradient(135deg, #004d40, #1b5e20); color: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-around; text-align: center; border: 1px solid #00e676; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #333; padding: 10px; text-align: left; }
        th { background: #2c2c2c; color: #00e676; }
        #chat-box { height: 250px; overflow-y: auto; background: #000; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; border: 1px solid #333; }
        .msg { max-width: 80%; padding: 10px; border-radius: 10px; font-size: 14px; margin-bottom: 8px; }
        .msg-driver { align-self: flex-end; background: #00e676; color: #000; }
        .msg-passenger { align-self: flex-start; background: #333; color: #fff; }
        .img-preview { width: 100%; height: 100px; background: #333; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; font-size: 12px; overflow: hidden; }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="browser-notice">âš ï¸ åµæ¸¬åˆ° App å…§å»ºç€è¦½å™¨ï¼è«‹é»æ“Šå³ä¸Šè§’ã€Œ...ã€ä¸¦é¸æ“‡ã€Œåœ¨ Chrome é–‹å•Ÿã€ï¼Œä»¥ç¢ºä¿åŠŸèƒ½æ­£å¸¸ã€‚</div>

    <div class="header" id="admin-trigger" onclick="triggerAdmin()">ğŸš• Jasper æ™ºæ…§åª’åˆç®¡ç†ç¸½ç«¯</div>

    <div class="container">
        <div id="admin-ui" class="admin-box">
            <div style="margin-bottom: 15px;">
                <button class="tab-btn active" id="tab-rep-btn" onclick="switchTab('report')">ğŸ“… æ¯æ—¥å°å¸³å ±è¡¨</button>
                <button class="tab-btn" id="tab-blk-btn" onclick="switchTab('blacklist')">ğŸš« åœæ¬Šåå–®</button>
                <button onclick="document.getElementById('admin-ui').style.display='none'" style="float:right; background:none; border:none; color:#888;">é—œé–‰</button>
            </div>

            <div id="tab-report" class="card">
                <h3 id="report-date-title">æ˜¨æ—¥åŒ¯æ¬¾æ¸…å–®</h3>
                <div id="payout-summary" style="background: #004d40; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 14px;"></div>
                <table>
                    <thead><tr><th>å¸æ©Ÿ</th><th>å¸³è™Ÿ</th><th>é‡‘é¡</th><th>è¶Ÿæ¬¡</th></tr></thead>
                    <tbody id="report-body"></tbody>
                </table>
            </div>

            <div id="tab-blacklist" class="card" style="display:none;">
                <h3>ğŸš« ç›®å‰åœæ¬Šä¸­å¸æ©Ÿ</h3>
                <table>
                    <thead><tr><th>å¸æ©Ÿ ID/å§“å</th><th>åŸå› </th><th>æˆªæ­¢</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="blacklist-body"></tbody>
                </table>
            </div>
        </div>

        <div id="main-flow">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-role active" id="btn-p" onclick="selectRole('passenger')">ä¹˜å®¢ç«¯</button>
                <button class="btn-role" id="btn-d" onclick="selectRole('driver')">å¸æ©Ÿç«¯</button>
            </div>

            <div id="driver-dashboard" style="display:none;" class="info-banner">
                <div><small>ğŸ’° ä»Šæ—¥ç‡Ÿæ”¶</small><br><b id="today-income-val" style="font-size:20px; color:#00e676;">$0</b></div>
                <div><small>ğŸ•’ å‡ºè»Šæ™‚æ•¸</small><br><b id="today-hours-val" style="font-size:20px; color:#00e676;">0.0h</b></div>
            </div>

            <div id="driver-register" style="display:none;" class="card">
                <h3 style="color:#00e676;">å¸æ©Ÿå¯¦åèªè­‰</h3>
                <input type="text" id="d-name" placeholder="å§“å">
                <input type="tel" id="d-phone" placeholder="é›»è©±">
                <input type="text" id="d-car" placeholder="è»Šç‰Œ (å¦‚ ABC-1234)">
                <input type="text" id="d-bank" placeholder="æ”¶æ¬¾å¸³è™Ÿ (åœ‹æ³°/è¡—å£)">
                <label style="font-size:12px; color:#00e676;">ğŸ“¸ åŸ·æ¥­ç™»è¨˜è­‰æ­£é¢</label>
                <input type="file" accept="image/*" onchange="previewImg(this, 'p-front')">
                <div class="img-preview" id="p-front">é è¦½</div>
                <button class="btn-main" onclick="saveDriverProfile()">æäº¤è³‡æ–™ä¸¦é–‹å§‹æ¥å–®</button>
            </div>

            <div id="passenger-ui">
                <div class="card" style="background:#004d40; border-color:#00e676; padding:15px; text-align:center; font-size:14px;">
                    <b>ğŸ’ Jasper å®˜æ–¹å¸³è™Ÿ (å…ˆåŒ¯æ¬¾å¾Œç™¼å–®)</b><br>
                    åœ‹æ³°(013): 125506256272 | è¡—å£: 909191462
                </div>
                <div class="card">
                    <label style="color:#00e676; font-size:12px;">ğŸ“… é ç´„ä¸Šè»Šæ™‚é–“</label>
                    <input type="datetime-local" id="p-book-time" onchange="calculateFare()">
                    <input type="tel" id="p-phone" placeholder="ğŸ“ æ‚¨çš„é›»è©±">
                    <input type="text" id="p-start" placeholder="ğŸ“ èµ·é»" onblur="calculateFare()">
                    <input type="text" id="p-end" placeholder="ğŸ ç›®çš„åœ°" onblur="calculateFare()">
                    <div id="fare-display" style="display:none; color:#ffeb3b; font-size:13px; margin-bottom:15px; line-height:1.5;"></div>
                    <label style="color:#00e676; font-size:12px;">ğŸš€ é¡å¤–åŠ æˆè²»ç”¨ (è‡ªé¡˜å°è²»)ï¼š</label>
                    <input type="number" id="p-extra" value="0" oninput="updateTotalFare()">
                    <input type="number" id="p-total" placeholder="å»ºè­°åŒ¯æ¬¾ç¸½é¡" readonly style="background:#333; color:#00e676; font-size:20px; font-weight:bold;">
                    <button class="btn-main" onclick="postOrder()">ç¢ºèªåŒ¯æ¬¾ä¸¦ç™¼é€å«è»Š</button>
                </div>
            </div>

            <div id="driver-ui" style="display:none;"><div id="order-list">æœå°‹è¡Œç¨‹ä¸­...</div></div>

            <div id="chat-section" style="display:none;">
                <div id="match-display" class="card" style="text-align:center; color:#00e676; font-weight:bold; padding:15px;"></div>
                <button onclick="handleCancel()" style="background:#444; color:#888; border:none; padding:10px; width:100%; border-radius:8px; margin-bottom:10px; font-size:12px;">å–æ¶ˆæ­¤è¨‚å–® (1å°æ™‚å…§å–æ¶ˆå°‡åœæ¬Š)</button>
                <div class="card"><div id="chat-box"></div>
                <div style="display:flex; gap:10px; padding:10px;">
                    <input type="text" id="chat-input" placeholder="å‚³é€è¨Šæ¯..." style="margin-bottom:0;">
                    <button style="background:#2979ff; border:none; color:white; border-radius:8px; padding:0 20px;" onclick="sendMessage()">ç™¼é€</button>
                </div></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config (Jasper å°ˆå±¬)
        const firebaseConfig = {
            apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68",
            authDomain: "jasper-taxi.firebaseapp.com",
            projectId: "jasper-taxi",
            storageBucket: "jasper-taxi.firebasestorage.app",
            messagingSenderId: "558407272439",
            appId: "1:558407272439:web:e48abaae404530a75c90f2",
            databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let userId = localStorage.getItem('jasper_user_id') || 'u' + Date.now();
        localStorage.setItem('jasper_user_id', userId);
        let currentRole = 'passenger', activeOrderId = null, clickCount = 0, baseFare = 0, sessionStart = null;
        const ADMIN_PASS = "Jasper888";

        window.onload = function() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('p-book-time').value = now.toISOString().slice(0,16);
            checkBrowser();
        };

        function triggerAdmin() {
            clickCount++;
            if(clickCount >= 5) {
                const p = prompt("Jasper è€å¸«ï¼Œè«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š");
                if(p === ADMIN_PASS) { document.getElementById('admin-ui').style.display='block'; switchTab('report'); }
                clickCount = 0;
            }
        }

        function switchTab(tab) {
            document.getElementById('tab-report').style.display = tab==='report'?'block':'none';
            document.getElementById('tab-blacklist').style.display = tab==='blacklist'?'block':'none';
            document.getElementById('tab-rep-btn').className = tab==='report'?'tab-btn active':'tab-btn';
            document.getElementById('tab-blk-btn').className = tab==='blacklist'?'tab-btn active':'tab-btn';
            if(tab==='report') generateReport(); else loadBlacklist();
        }

        function generateReport() {
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];
            document.getElementById('report-date-title').innerText = `${dateStr} å®Œè³½å°å¸³ (ä»Šæ—¥ 14:00 åŒ¯æ¬¾)`;
            db.ref('orders').once('value', snap => {
                const driverMap = {}; let grandTotal = 0;
                snap.forEach(c => {
                    const o = c.val();
                    const oDate = new Date(o.createTime).toISOString().split('T')[0];
                    if(oDate === dateStr && o.status === 'finished' && o.dId) {
                        if(!driverMap[o.dId]) driverMap[o.dId] = { name: o.dName, total: 0, count: 0 };
                        driverMap[o.dId].total += Number(o.fare); driverMap[o.dId].count++; grandTotal += Number(o.fare);
                    }
                });
                const body = document.getElementById('report-body'); body.innerHTML = '';
                for(let id in driverMap) {
                    db.ref('drivers/'+id+'/bank').once('value', b => {
                        body.innerHTML += `<tr><td>${driverMap[id].name}</td><td>${b.val()||'æœªå¡«'}</td><td>$${driverMap[id].total}</td><td>${driverMap[id].count}</td></tr>`;
                    });
                }
                document.getElementById('payout-summary').innerHTML = `ç¸½æˆäº¤é¡ï¼š$${grandTotal} | æ‡‰åŒ¯æ¬¾å°è±¡ï¼š${Object.keys(driverMap).length} ä½`;
            });
        }

        function loadBlacklist() {
            db.ref('blacklist/drivers').on('value', snap => {
                const body = document.getElementById('blacklist-body'); body.innerHTML = '';
                const now = Date.now();
                snap.forEach(c => {
                    const b = c.val(); const left = Math.round((b.until - now) / 3600000);
                    if(left > 0) body.innerHTML += `<tr><td>${c.key}</td><td>${b.reason}</td><td>${left}h</td><td><button onclick="db.ref('blacklist/drivers/${c.key}').remove()">è§£å°</button></td></tr>`;
                    else db.ref('blacklist/drivers/'+c.key).remove();
                });
            });
        }

        function calculateFare() {
            const start = document.getElementById('p-start').value, end = document.getElementById('p-end').value;
            if(!start || !end) return;
            const bDate = new Date(document.getElementById('p-book-time').value);
            const t = bDate.getTime(), h = bDate.getHours();
            const sStart = new Date(2026, 1, 11, 0).getTime(), sEnd = new Date(2026, 1, 22, 24).getTime();
            let base = 85, km = 5.0 * 25, traf = 8 * 5, sur = 0, n = "ä¸€èˆ¬";
            if(t >= sStart && t <= sEnd) { sur = 30; n = "ğŸ§§ æ˜¥ç¯€åŠ æˆ (+30)"; }
            else if(h >= 23 || h <= 6) { sur = 20; n = "ğŸŒ™ å¤œé–“åŠ æˆ (+20)"; }
            baseFare = Math.round(base + km + traf + sur);
            document.getElementById('fare-display').style.display = 'block';
            document.getElementById('fare-display').innerHTML = `å±¬æ€§ï¼š${n} | ç³»çµ±é ä¼°è²»ï¼š$${baseFare}`;
            updateTotalFare();
        }
        function updateTotalFare() {
            const extra = Number(document.getElementById('p-extra').value) || 0;
            document.getElementById('p-total').value = baseFare + extra;
        }

        function handleCancel() {
            db.ref('orders/'+activeOrderId).once('value', snap => {
                const o = snap.val(); const now = Date.now(); const book = new Date(o.bookTime).getTime();
                if(confirm("ç¢ºå®šå–æ¶ˆï¼Ÿé ç´„ 1 å°æ™‚å…§å–æ¶ˆå°‡åœæ¬Š 24 å°æ™‚ã€‚")) {
                    if(currentRole === 'driver' && (book - now) <= 3600000) {
                        db.ref('blacklist/drivers/'+userId).set({ reason: "é ç´„å–® 1 å°æ™‚å…§å–æ¶ˆ", until: now + 86400000 });
                        alert("é•è¦å–æ¶ˆï¼å¸³è™Ÿåœæ¬Šä¸€å¤©ã€‚");
                    }
                    db.ref('orders/'+activeOrderId).update({ status: 'pay_confirmed', dId: null, dName: null, resell: true });
                    location.reload();
                }
            });
        }

        function previewImg(input, tid) {
            const f = input.files[0]; if(f) {
                const r = new FileReader(); r.onload = (e) => document.getElementById(tid).innerHTML = `<img src="${e.target.result}">`;
                r.readAsDataURL(f);
            }
        }

        function saveDriverProfile() {
            const n = document.getElementById('d-name').value, c = document.getElementById('d-car').value, b = document.getElementById('d-bank').value;
            const f = document.querySelector('#p-front img')?.src;
            if(!n || !c || !f || !b) return alert("è³‡è¨Šä¸å…¨");
            const p = { name: n, car: c, bank: b, img: f, userId };
            localStorage.setItem('driver_profile', JSON.stringify(p));
            db.ref('drivers/'+userId).set(p); location.reload();
        }

        function selectRole(role) {
            currentRole = role;
            const p = localStorage.getItem('driver_profile');
            document.getElementById('btn-p').className = role==='passenger'?'btn-role active':'btn-role';
            document.getElementById('btn-d').className = role==='driver'?'btn-role active':'btn-role';
            document.getElementById('passenger-ui').style.display = role==='passenger'?'block':'none';
            document.getElementById('driver-ui').style.display = (role==='driver' && p)?'block':'none';
            document.getElementById('driver-register').style.display = (role==='driver' && !p)?'block':'none';
            document.getElementById('driver-dashboard').style.display = (role==='driver' && p)?'flex':'none';
            if(role==='driver' && p) { startDuty(true); updateDuty(); listenOrders(); } else startDuty(false);
        }

        function startDuty(start) {
            const t = new Date().toISOString().split('T')[0];
            if(start) { sessionStart = Date.now(); } else if(sessionStart) {
                const dur = Date.now() - sessionStart;
                db.ref(`duty/${userId}/${t}`).transaction(curr => (curr||0) + dur); sessionStart = null;
            }
        }
        function updateDuty() {
            const t = new Date().toISOString().split('T')[0];
            db.ref(`duty/${userId}/${t}`).on('value', s => document.getElementById('today-hours-val').innerText = `${((s.val()||0)/3600000).toFixed(1)}h`);
            db.ref(`income/${userId}/${t}`).on('value', s => document.getElementById('today-income-val').innerText = `$${s.val()||0}`);
        }

        function postOrder() {
            const ph = document.getElementById('p-phone').value, f = document.getElementById('p-total').value;
            const s = document.getElementById('p-start').value, e = document.getElementById('p-end').value;
            const b = document.getElementById('p-book-time').value;
            if(!ph || !f || !s || !e) return alert("è³‡è¨Šä¸å…¨");
            db.ref('blacklist/passengers/'+ph).once('value', snap => {
                if(snap.exists()) return alert("é›»è©±åœæ¬Šä¸­");
                const ref = db.ref('orders').push(); activeOrderId = ref.key;
                ref.set({ pPhone: ph, fare: f, start: s, end: e, bookTime: b, status: 'waiting', pId: userId, createTime: Date.now() });
                loadChat(activeOrderId);
            });
        }

        function listenOrders() {
            db.ref('orders').on('value', snap => {
                const list = document.getElementById('order-list'); list.innerHTML = '';
                snap.forEach(c => {
                    const o = c.val(); if(o.status==='pay_confirmed') {
                        list.innerHTML += `<div class="card">ğŸ“ ${o.start} â” ${o.end}<br>ğŸ“… ${o.bookTime.replace('T',' ')}<br>ğŸ’µ $${o.fare}<br><button class="btn-main" onclick="acceptOrder('${c.key}')">æ¶å–®</button></div>`;
                    }
                });
            });
        }

        function acceptOrder(id) {
            db.ref('blacklist/drivers/'+userId).once('value', s => {
                if(s.exists()) return alert("åœæ¬Šä¸­ç„¡æ³•æ¥å–®");
                const p = JSON.parse(localStorage.getItem('driver_profile'));
                db.ref('orders/'+id).transaction(o => {
                    if(o && o.status==='pay_confirmed') { o.status='accepted'; o.dId=userId; o.dName=p.name; o.dCar=p.car; return o; }
                }, (err, com) => { if(com) loadChat(id); });
            });
        }

        function loadChat(id) {
            activeOrderId = id; document.getElementById('main-flow').style.display='none'; document.getElementById('chat-section').style.display='block';
            db.ref('orders/'+id).on('value', s => {
                const o = s.val(); if(!o) return;
                document.getElementById('match-display').innerText = `${o.status==='waiting'?'å°å¸³ä¸­':'å¸æ©Ÿ:'+o.dName} | $${o.fare}`;
                if(o.status==='accepted' && currentRole==='driver') {
                    document.getElementById('match-display').innerHTML += `<br><button onclick="db.ref('orders/${activeOrderId}').update({status:'finished'})">å®Œæˆè¡Œç¨‹</button>`;
                }
            });
            db.ref('messages/'+id).on('value', s => {
                const box = document.getElementById('chat-box'); box.innerHTML = '';
                s.forEach(m => { const d = m.val(); box.innerHTML += `<div class="msg msg-${d.role}">${d.text}</div>`; });
                box.scrollTop = box.scrollHeight;
            });
        }
        function sendMessage() { const t = document.getElementById('chat-input').value; if(t) { db.ref('messages/'+activeOrderId).push({role:currentRole, text:t}); document.getElementById('chat-input').value=''; } }
        function closeChat() { document.getElementById('main-flow').style.display='block'; document.getElementById('chat-section').style.display='none'; }
        function checkBrowser() { const ua = navigator.userAgent; if(ua.indexOf("Messenger")>-1||ua.indexOf("Line")>-1) document.getElementById('browser-notice').style.display='block'; }
    </script>
</body>
</html>
