// --- åƒ…ç¯€éŒ„ä¸¦ä¿®æ”¹æ ¸å¿ƒé‚è¼¯éƒ¨åˆ†ï¼Œå…¶é¤˜é»‘é‡‘ä»‹é¢èˆ‡ Config ä¿æŒä¸è®Š ---

function acceptOrder(id, dist) {
    if(dist > 5 && !confirm(`æ­¤ä¹˜å®¢è·é›¢æ‚¨ ${dist}km è¼ƒé ï¼Œç¢ºå®šè¦æ¶å–®å—ï¼Ÿ`)) return;
    
    db.ref('orders/' + id).transaction(order => {
        if(order && order.status === 'waiting') {
            order.status = 'accepted';
            order.dLat = userLat; 
            order.dLon = userLon; // è¨˜éŒ„å¸æ©Ÿç•¶å‰ä½ç½®
            return order;
        }
    }, (err, committed) => {
        if(committed) { 
            activeOrderId = id; 
            listenForChat(id); 
            
            // --- æ–°å¢ï¼šè‡ªå‹•ç™¼é€ç³»çµ±è­¦ç¤ºè¨Šæ¯ ---
            if(dist > 5) {
                const sysMsg = `âš ï¸ ç³»çµ±æç¤ºï¼šå¸æ©Ÿè·é›¢è¼ƒé  (${dist}km)ï¼Œè«‹é›™æ–¹ç¢ºèªé è¨ˆæŠµé”æ™‚é–“ã€‚`;
                db.ref('messages/' + id).push({
                    role: 'system', // ä»¥ç³»çµ±èº«åˆ†ç™¼è¨€
                    text: sysMsg,
                    time: Date.now()
                });
            }
        }
    });
}

// ä¿®æ”¹ç›£è½å°è©±çš„é¡¯ç¤ºé‚è¼¯ï¼Œå¢åŠ ç³»çµ±è¨Šæ¯æ¨£å¼
function listenForChat(orderId) {
    document.getElementById('chat-section').style.display = 'block';
    
    // ç›£è½è¨‚å–®ç‹€æ…‹ä¸¦é¡¯ç¤ºä¹˜å®¢ç«¯è­¦ç¤ºæ¡†
    db.ref('orders/' + orderId).on('value', snap => {
        const o = snap.val();
        if(o.status === 'accepted' && o.dLat && o.pLat) {
            const d = calcDist(o.pLat, o.pLon, o.dLat, o.dLon).toFixed(1);
            const alertBox = document.getElementById('dist-alert-p');
            if(d > 5) alertBox.innerHTML = `<div class="dist-warning">âš ï¸ å¸æ©Ÿè·é›¢è¼ƒé  (${d}km)</div>`;
            else alertBox.innerHTML = `<div style="color:#00e676; text-align:center; margin-bottom:10px;">ğŸš• å¸æ©Ÿè·é›¢ç´„ ${d}km</div>`;
        }
    });

    db.ref('messages/' + orderId).on('value', snap => {
        const msgs = snap.val();
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        for(let m in msgs) {
            const mData = msgs[m];
            const div = document.createElement('div');
            // æ ¹æ“šä¸åŒèº«åˆ†å¥—ç”¨æ¨£å¼
            if(mData.role === 'system') {
                div.style = "align-self:center; background:#444; color:#ffeb3b; font-size:12px; padding:5px 10px; border-radius:5px; margin:5px 0;";
                div.innerText = mData.text;
            } else {
                div.className = `msg msg-${mData.role}`;
                div.innerText = mData.text;
            }
            box.appendChild(div);
        }
        box.scrollTop = box.scrollHeight;
    });
}
