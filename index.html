<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - 2026 çµ‚æ¥µå„ªåŒ–ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        .header { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; cursor: pointer; user-select: none; }
        .container { padding: 15px; max-width: 1000px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; }
        .btn-role { flex: 1; padding: 15px; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-role.active { background: #00e676; color: #000; }
        input { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 15px; background: #00e676; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-line { background: #00c300; color: white; margin-top: 10px; }
        
        /* ç®¡ç†å“¡å¾Œå° */
        .admin-box { display: none; margin-top: 10px; border: 2px solid #00e676; padding: 10px; border-radius: 12px; background: #000; }
        .tab-btn { padding: 8px 12px; background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 12px; }
        .tab-btn.active { background: #00e676; color: #000; }
        
        /* åœ–ç‰‡å…§ç½®æ”¾å¤§å™¨ (è§£æ±º 404 å•é¡Œ) */
        #img-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 30000; justify-content: center; align-items: center; }
        #img-viewer img { max-width: 95%; max-height: 90%; border: 2px solid #00e676; }
        .img-thumb { width: 45px; height: 45px; object-fit: cover; border: 1px solid #555; margin-right: 3px; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
    </style>
</head>
<body>

    <div id="img-viewer" onclick="this.style.display='none'"><img id="viewer-img" src=""></div>

    <div class="header" onclick="triggerAdmin()">ğŸš• Jasper æ™ºæ…§åª’åˆç®¡ç†ç¸½ç«¯</div>

    <div class="container">
        <div id="admin-ui" class="admin-box">
            <div style="display:flex; gap:5px; overflow-x:auto; padding-bottom:10px;">
                <button class="tab-btn active" id="tab-p" onclick="switchTab('payment')">ğŸ’° åŒ¯æ¬¾æ”¾å–®</button>
                <button class="tab-btn" id="tab-v" onclick="switchTab('verify')">ğŸ“„ å¸æ©Ÿå¯©æ ¸</button>
                <button class="tab-btn" id="tab-m" onclick="switchTab('members')">ğŸ‘¥ å¸æ©ŸåéŒ„</button>
                <button onclick="document.getElementById('admin-ui').style.display='none'" style="margin-left:auto; color:red; border:none; background:none;">é—œé–‰</button>
            </div>
            <div id="admin-content"></div>
        </div>

        <div id="main-flow">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-role" id="btn-p" onclick="selectRole('passenger')">ä¹˜å®¢ç«¯</button>
                <button class="btn-role" id="btn-d" onclick="selectRole('driver')">å¸æ©Ÿç«¯</button>
            </div>

            <div id="driver-register" style="display:none;" class="card">
                <h3 style="color:#00e676; margin-top:0;">å¸æ©Ÿè¨»å†Š (èº«åˆ†å¯©æ ¸)</h3>
                <input type="text" id="d-name" placeholder="å§“å">
                <input type="tel" id="d-phone" placeholder="é›»è©±è™Ÿç¢¼">
                <input type="text" id="d-car" placeholder="è»Šç‰Œè™Ÿç¢¼ (å¦‚ ABC-1234)">
                <input type="text" id="d-lic-no" placeholder="åŸ·æ¥­ç™»è¨˜è­‰è­‰è™Ÿ">
                <input type="text" id="d-bank" placeholder="æ”¶æ¬¾å¸³è™Ÿ (åœ‹æ³°/è¡—å£)">
                
                <small style="color:#00e676;">ğŸ“¸ è­‰ç…§ç…§ç‰‡ä¸Šå‚³å€</small>
                <input type="file" multiple accept="image/*" onchange="handleImgs(this)">
                <div id="previews" style="display:flex; gap:5px; margin:10px 0;"></div>

                <button class="btn-main" onclick="saveDriver()">1. æäº¤é›²ç«¯è³‡æ–™</button>
                <button class="btn-main btn-line" onclick="sendToLine()">2. ä¸€éµå°‡è³‡æ–™å‚³çµ¦ Jasper è€å¸« (Line)</button>
            </div>

            <div id="driver-ui" style="display:none;"><div id="order-list">æœå°‹è¡Œç¨‹ä¸­...</div></div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68", databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ADMIN_PASS = "Jasper888";
        let userId = localStorage.getItem('jasper_user_id') || 'u' + Date.now();
        localStorage.setItem('jasper_user_id', userId);
        let adminClicks = 0, uploaded = [];

        // --- æ ¸å¿ƒå„ªåŒ–ï¼šå³æ™‚ç›£è½å¸æ©Ÿç‹€æ…‹ (è§£æ±ºå¯©æ ¸é€šéå»ä»æ“‹ä½çš„å•é¡Œ) ---
        function watchDriver() {
            db.ref('drivers/' + userId).on('value', snap => {
                const d = snap.val();
                if (d && d.status === 'approved') {
                    document.getElementById('driver-register').style.display = 'none';
                    document.getElementById('driver-ui').style.display = 'block';
                    listenOrders();
                }
            });
        }

        function selectRole(r) {
            document.getElementById('btn-p').className = r==='passenger'?'btn-role active':'btn-role';
            document.getElementById('btn-d').className = r==='driver'?'btn-role active':'btn-role';
            if(r==='driver') {
                db.ref('drivers/'+userId).once('value', s => {
                    const d = s.val();
                    if(!d) document.getElementById('driver-register').style.display='block';
                    else if(d.status==='approved') {
                        document.getElementById('driver-ui').style.display='block';
                        listenOrders();
                    } else {
                        alert("Jasper è€å¸«æ­£åœ¨å¯©æ ¸ä¸­ï¼Œé€šéå¾Œæ­¤é é¢å°‡è‡ªå‹•è·³è½‰ã€‚");
                        watchDriver(); // å•Ÿå‹•å³æ™‚ç›£è½
                    }
                });
            }
        }

        // --- ä¸€éµå‚³ LINE é‚è¼¯ ---
        function sendToLine() {
            const name = document.getElementById('d-name').value;
            const phone = document.getElementById('d-phone').value;
            const car = document.getElementById('d-car').value;
            const lic = document.getElementById('d-lic-no').value;
            if(!name || !phone || !car) return alert("è«‹å…ˆå¡«å¯«è³‡æ–™");
            
            const msg = `Jasper è€å¸«æ‚¨å¥½ï¼Œæˆ‘æ˜¯å¸æ©Ÿç”³è«‹äººï¼š\nå§“åï¼š${name}\né›»è©±ï¼š${phone}\nè»Šç‰Œï¼š${car}\nç™»è¨˜è­‰è™Ÿï¼š${lic}\nå·²æäº¤ç…§ç‰‡è«‹æŸ¥æ”¶ã€‚`;
            window.open(`https://line.me/ti/p/~love_ice_boy?text=${encodeURIComponent(msg)}`);
        }

        function saveDriver() {
            const n = document.getElementById('d-name').value, p = document.getElementById('d-phone').value;
            if(!n || uploaded.length < 1) return alert("è³‡æ–™ä¸å…¨");
            db.ref('drivers/'+userId).set({
                name:n, phone:p, car:document.getElementById('d-car').value,
                licNo:document.getElementById('d-lic-no').value, bank:document.getElementById('d-bank').value,
                status:'pending', userId:userId, img1: uploaded[0]||""
            }).then(() => { alert("å·²æäº¤é›²ç«¯ï¼è«‹æ¥è‘—é»æ“Šä¸‹æ–¹ç¶ è‰²æŒ‰éˆ•å‚³ Lineã€‚"); watchDriver(); });
        }

        // --- ç®¡ç†å“¡ï¼šä¿®å¾© Undefined èˆ‡ 404 å•é¡Œ ---
        function loadAdminOrders() {
            db.ref('orders').on('value', snap => {
                let h = '<h4>ğŸ’° åŒ¯æ¬¾æ”¾å–® (å¾…æ ¸å¸³)</h4><table><tr><th>æ™‚é–“</th><th>ä¹˜å®¢é›»è©±</th><th>èµ·é»â”çµ‚é»</th><th>é‡‘é¡</th><th>æ“ä½œ</th></tr>';
                snap.forEach(c => {
                    const o = c.val();
                    if(o.status === 'waiting') {
                        const date = o.createTime ? new Date(o.createTime).toLocaleString() : 'æœªçŸ¥';
                        h += `<tr><td>${date}</td><td>${o.pPhone || 'ç„¡'}</td><td>${o.start}â”${o.end}</td><td>$${o.fare || 0}</td><td><button onclick="db.ref('orders/${c.key}').update({status:'pay_confirmed'})">ç¢ºèªæ”¾å–®</button></td></tr>`;
                    }
                });
                document.getElementById('admin-content').innerHTML = h + '</table>';
            });
        }

        function triggerAdmin() {
            adminClicks++;
            if(adminClicks >= 5) {
                const p = prompt("ç®¡ç†å¯†ç¢¼ï¼š");
                if(p === ADMIN_PASS) { document.getElementById('admin-ui').style.display='block'; switchTab('payment'); }
                adminClicks = 0;
            }
        }

        function zoomImg(src) { document.getElementById('viewer-img').src = src; document.getElementById('img-viewer').style.display = 'flex'; }
        function handleImgs(i) { /* è™•ç†ç…§ç‰‡é è¦½é‚è¼¯ */ }
        function switchTab(t) { /* åˆ†é åˆ‡æ›é‚è¼¯ */ }
    </script>
</body>
</html>
