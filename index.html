<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - çµ‚æ¥µç¶­å®‰è²¡å‹™ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        .header { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; cursor: pointer; user-select: none; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; }
        .btn-role { flex: 1; padding: 15px; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-role.active { background: #00e676; color: #000; }
        input, select { width: 100%; padding: 14px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        .btn-main { width: 100%; padding: 18px; background: #00e676; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 18px; }
        .admin-box { display: none; margin-top: 20px; border: 2px solid #00e676; padding: 15px; border-radius: 10px; }
        .tab-btn { padding: 10px 15px; background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px; font-size: 13px; }
        .tab-btn.active { background: #00e676; color: #000; }
        .img-preview { width: 100%; height: 120px; background: #333; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; font-size: 12px; overflow: hidden; border: 1px dashed #555; }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; }
        .pet-notice { background: #ff5252; color: #fff; padding: 10px; border-radius: 8px; font-size: 12px; margin-bottom: 15px; text-align: center; font-weight: bold; }
        .surcharge-box { background: #2e7d32; color: #fff; padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 10px; text-align: center; border: 1px solid #00e676; }
    </style>
</head>
<body>

    <div class="header" onclick="triggerAdmin()">ğŸš• Jasper æ™ºæ…§åª’åˆç®¡ç†ç¸½ç«¯</div>

    <div class="container">
        <div id="admin-ui" class="admin-box">
            <div style="margin-bottom: 15px; display: flex; overflow-x: auto;">
                <button class="tab-btn active" onclick="switchTab('payment')">ğŸ’° åŒ¯æ¬¾æ”¾å–®</button>
                <button class="tab-btn" onclick="switchTab('verify')">ğŸ“„ å¸æ©Ÿå¯©æ ¸</button>
                <button onclick="document.getElementById('admin-ui').style.display='none'" style="float:right; border:none; background:none; color:#888;">é—œé–‰</button>
            </div>
            <div id="admin-content"></div>
        </div>

        <div id="main-flow">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-role active" id="btn-p" onclick="selectRole('passenger')">ä¹˜å®¢ç«¯</button>
                <button class="btn-role" id="btn-d" onclick="selectRole('driver')">å¸æ©Ÿç«¯</button>
            </div>

            <div id="passenger-ui">
                <div class="card" style="background:#004d40; border-color:#00e676; padding:15px; text-align:center;">
                    <b>ğŸ’ Jasper æ”¶æ¬¾ (å…ˆåŒ¯æ¬¾å¾Œå¯©æ ¸)</b><br>
                    åœ‹æ³°(013): 125506256272 | è¡—å£: 909191462
                </div>
                <div class="pet-notice">ğŸ¾ å¯µç‰©è¦ç¯„ï¼šå¿…é ˆè£åœ¨ç± å­è£¡ï¼Œå¦å‰‡å¸æ©Ÿæœ‰æ¬Šæ‹’è¼‰ã€‚</div>
                <div class="card">
                    <label style="font-size:12px; color:#00e676;">ğŸ“… é ç´„ä¸Šè»Šæ™‚é–“</label>
                    <input type="datetime-local" id="p-book-time" onchange="calculateBaseFare()">
                    
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;">
                            <label style="font-size:12px; color:#00e676;">ğŸ‘¤ ä¹˜å®¢æ•¸é‡</label>
                            <select id="p-count"><option value="1">1ä½</option><option value="2">2ä½</option><option value="3">3ä½</option><option value="4">4ä½</option></select>
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:12px; color:#00e676;">ğŸ§³ è¡Œææ•¸é‡</label>
                            <select id="p-luggage"><option value="0">ç„¡è¡Œæ</option><option value="1">1ä»¶</option><option value="2">2ä»¶</option><option value="3">3ä»¶ä»¥ä¸Š</option></select>
                        </div>
                    </div>

                    <label style="font-size:12px; color:#00e676;">ğŸ• å¯µç‰© (é ˆè£ç± )</label>
                    <select id="p-pet"><option value="å¦">å¦</option><option value="æ˜¯ (å·²ç¢ºèªè£ç± )">æ˜¯ (å·²ç¢ºèªè£ç± )</option></select>

                    <input type="tel" id="p-phone" placeholder="ğŸ“ è¯çµ¡é›»è©±">
                    <input type="text" id="p-start" placeholder="ğŸ“ èµ·é»" onblur="calculateBaseFare()">
                    <input type="text" id="p-end" placeholder="ğŸ ç›®çš„åœ°" onblur="calculateBaseFare()">
                    
                    <div id="fare-display" style="display:none; color:#ffeb3b; font-size:13px; margin-bottom:15px; line-height:1.5;"></div>
                    
                    <div class="surcharge-box">
                        ğŸš€ <b>å¸Œæœ›è»Šå¿«é»åˆ°ï¼Ÿ</b><br>è«‹è¼¸å…¥æƒ³é¡å¤–å¤šçµ¦å¸æ©Ÿçš„åŠ æˆè²»ç”¨ï¼š
                    </div>
                    <input type="number" id="p-extra" value="0" placeholder="é¡å¤–åŠ æˆé‡‘é¡ (ä¾‹: 50)" oninput="updateTotal()">

                    <input type="number" id="p-total" placeholder="ğŸ’µ åŒ¯æ¬¾ç¸½é¡ (ç³»çµ±é ä¼°+è‡ªé¡˜åŠ æˆ)" readonly style="background:#333; color:#00e676; font-size:20px; font-weight:bold;">
                    
                    <button class="btn-main" onclick="postOrder()">ç¢ºèªåŒ¯æ¬¾ä¸¦ç™¼é€éœ€æ±‚</button>
                </div>
            </div>

            <div id="driver-register" style="display:none;" class="card">
                <h3 style="color:#00e676;">å¸æ©Ÿå¯¦åèªè­‰ (ç‡Ÿæ¥­è­‰å¯©æ ¸)</h3>
                <input type="text" id="d-name" placeholder="å§“å">
                <input type="tel" id="d-phone" placeholder="é›»è©±">
                <input type="text" id="d-car" placeholder="è»Šç‰Œ">
                <input type="text" id="d-bank" placeholder="æ”¶æ¬¾å¸³è™Ÿ (åœ‹æ³°/è¡—å£)">
                <label style="font-size:11px;">ğŸ“¸ ç‡Ÿæ¥­ç™»è¨˜è­‰ æ­£é¢</label>
                <input type="file" accept="image/*" onchange="previewImg(this, 'p-front')">
                <div class="img-preview" id="p-front">é è¦½æ­£é¢</div>
                <label style="font-size:11px;">ğŸ“¸ ç‡Ÿæ¥­ç™»è¨˜è­‰ åé¢</label>
                <input type="file" accept="image/*" onchange="previewImg(this, 'p-back')">
                <div class="img-preview" id="p-back">é è¦½åé¢</div>
                <button class="btn-main" onclick="saveDriverProfile()">æäº¤å¯©æ ¸</button>
            </div>

            <div id="driver-ui" style="display:none;"><div id="order-list">æœå°‹è¡Œç¨‹ä¸­...</div></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68",
            databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let userId = localStorage.getItem('jasper_user_id') || 'u' + Date.now();
        localStorage.setItem('jasper_user_id', userId);
        const ADMIN_PASS = "Jasper888";
        let adminClickCount = 0, baseCalculated = 0;

        // åˆå§‹åŒ–æ™‚é–“
        window.onload = function() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('p-book-time').value = now.toISOString().slice(0,16);
        };

        // è²»ç‡æ¼”ç®— (2026 æ˜¥ç¯€è‡ªå‹•åˆ¤å®š)
        function calculateBaseFare() {
            const start = document.getElementById('p-start').value, end = document.getElementById('p-end').value;
            if(!start || !end) return;
            const bD = new Date(document.getElementById('p-book-time').value);
            const t = bD.getTime(), h = bD.getHours();
            const sS = new Date(2026, 1, 11, 0).getTime(), sE = new Date(2026, 1, 22, 24).getTime();
            let base = 85, sur = 0, note = "ä¸€èˆ¬æ™‚æ®µ";
            if(t >= sS && t <= sE) { sur = 30; note = "ğŸ§§ 2026 æ˜¥ç¯€åŠ æˆ (+30)"; }
            else if(h >= 23 || h <= 6) { sur = 20; note = "ğŸŒ™ å¤œé–“åŠ æˆ (+20)"; }
            
            baseCalculated = Math.round(base + 125 + 40 + sur); // æ¨¡æ“¬é‡Œç¨‹èˆ‡ç­‰å¾…è²»
            document.getElementById('fare-display').style.display = 'block';
            document.getElementById('fare-display').innerHTML = `æ™‚æ®µï¼š${note} | ç³»çµ±é ä¼°åŸºç¤è²»ï¼š$${baseCalculated}`;
            updateTotal();
        }

        function updateTotal() {
            const extra = Number(document.getElementById('p-extra').value) || 0;
            document.getElementById('p-total').value = baseCalculated + extra;
        }

        // å¾Œå°èˆ‡æ¬Šé™é‚è¼¯ (ç•¥ï¼Œèˆ‡å‰è¿°ä¿®å¾©ç‰ˆä¸€è‡´)
        function triggerAdmin() {
            adminClickCount++;
            if (adminClickCount >= 5) {
                const p = prompt("Jasper å¯†ç¢¼ï¼š");
                if (p === ADMIN_PASS) { document.getElementById('admin-ui').style.display = 'block'; switchTab('payment'); }
                adminClickCount = 0;
            }
        }

        function switchTab(tab) {
            const content = document.getElementById('admin-content');
            if (tab === 'payment') {
                db.ref('orders').on('value', snap => {
                    let h = '<h4>ğŸ’° å¾…æ ¸å¸³ (å«è‡ªé¡˜åŠ æˆ)</h4>';
                    snap.forEach(c => {
                        const o = c.val(); if(o.status === 'waiting') {
                            h += `<div class="card">ğŸ‘¤ ${o.pPhone} | ğŸ’µ ç¸½æ”¶:$${o.fare}<br>âš¡ åŠ æˆå¾Œæ”¾å–®ï¼Œå¸æ©Ÿæ›´å®¹æ˜“æ¶å–®<br><button onclick="db.ref('orders/${c.key}').update({status:'pay_confirmed'})" style="background:#00e676; padding:8px; width:100%; border-radius:5px;">âœ… ç¢ºèªå…¥å¸³</button></div>`;
                        }
                    });
                    content.innerHTML = h;
                });
            } else if (tab === 'verify') {
                db.ref('drivers').on('value', snap => {
                    let h = '<h4>ğŸ“„ å¸æ©Ÿè­‰ä»¶å¯©æ ¸</h4>';
                    snap.forEach(c => {
                        const d = c.val(); if(d.status === 'pending') h += `<div class="card">${d.name} | ${d.car}<br><details><summary>æŸ¥é–±æ­£åé¢</summary><img src="${d.imgFront}" style="width:100%;"><img src="${d.imgBack}" style="width:100%;"></details><button onclick="db.ref('drivers/${c.key}').update({status:'approved'})" style="background:#00e676; padding:8px; width:100%; border-radius:5px;">âœ… é€šéå¯©æ ¸</button></div>`;
                    });
                    content.innerHTML = h;
                });
            }
        }

        function saveDriverProfile() {
            const n = document.getElementById('d-name').value, p = document.getElementById('d-phone').value;
            const c = document.getElementById('d-car').value, b = document.getElementById('d-bank').value;
            const front = document.querySelector('#p-front img')?.src, bk = document.querySelector('#p-back img')?.src;
            if(!n || !p || !front || !bk) return alert("è³‡æ–™ä¸å…¨");
            db.ref('drivers/'+userId).set({ name:n, phone:p, car:c, bank:b, imgFront:front, imgBack:bk, status:'pending', userId });
            alert("æäº¤æˆåŠŸï¼Œè«‹å¾…å¯©æ ¸ã€‚"); location.reload();
        }

        function postOrder() {
            const f = document.getElementById('p-total').value;
            if(!f || f <= 0) return alert("è«‹ç¢ºèªè¡Œç¨‹èˆ‡åŒ¯æ¬¾ç¸½é¡");
            db.ref('orders').push().set({
                pPhone: document.getElementById('p-phone').value, fare: f,
                start: document.getElementById('p-start').value, end: document.getElementById('p-end').value,
                bookTime: document.getElementById('p-book-time').value,
                passengerCount: document.getElementById('p-count').value,
                luggageCount: document.getElementById('p-luggage').value,
                hasPet: document.getElementById('p-pet').value,
                status: 'waiting', pId: userId, createTime: Date.now()
            });
            alert("éœ€æ±‚å·²ç™¼é€ï¼Jasper è€å¸«æ ¸å¸³å¾Œï¼Œé«˜åƒ¹å–®å°‡æ›´æœ‰ç«¶çˆ­åŠ›ã€‚");
        }

        function selectRole(role) {
            document.getElementById('passenger-ui').style.display = (role === 'passenger') ? 'block' : 'none';
            if (role === 'driver') {
                db.ref('drivers/' + userId).once('value', snap => {
                    const d = snap.val();
                    if (!d) document.getElementById('driver-register').style.display = 'block';
                    else if (d.status === 'pending') alert("â³ è³‡æ–™å¯©æ ¸ä¸­ã€‚");
                    else { document.getElementById('driver-ui').style.display = 'block'; listenOrders(); }
                });
            }
        }

        function listenOrders() {
            db.ref('orders').on('value', snap => {
                const list = document.getElementById('order-list'); list.innerHTML = '';
                snap.forEach(c => {
                    const o = c.val(); if(o.status==='pay_confirmed') {
                        list.innerHTML += `<div class="card" style="border:1px solid #00e676;">ğŸ“ ${o.start}â”${o.end}<br>ğŸ’µ <b>ç¸½é¡: $${o.fare}</b><br>ğŸ¾ å¯µç‰©:${o.hasPet} | ğŸ‘¥:${o.passengerCount}äºº<br><button onclick="db.ref('orders/${c.key}').update({status:'accepted', dId:userId})" style="background:#00e676; width:100%; border:none; padding:10px; border-radius:8px; font-weight:bold; margin-top:5px;">ç«‹å³æ¶å–®</button></div>`;
                    }
                });
            });
        }
        
        function previewImg(input, tid) {
            const f = input.files[0]; if(f) {
                const r = new FileReader(); r.onload = (e) => document.getElementById(tid).innerHTML = `<img src="${e.target.result}">`;
                r.readAsDataURL(f);
            }
        }
    </script>
</body>
</html>
