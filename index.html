<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - å®‰å…¨å¯†ç¢¼æ§ç®¡ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        .header { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; cursor: pointer; user-select: none; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        .btn-role { flex: 1; padding: 15px; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-role.active { background: #00e676; color: #000; }
        input { width: 100%; padding: 14px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 18px; background: #00e676; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .admin-box { display: none; border: 2px solid #00e676; padding: 15px; border-radius: 10px; background: #000; margin-bottom: 20px; }
        .payment-info { background: #004d40; color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; border: 1px solid #00e676; }
        #chat-box { height: 200px; overflow-y: auto; background: #000; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #333; }
    </style>
</head>
<body>

    <div class="header" onclick="triggerAdmin()">ğŸš• Jasper æ™ºæ…§åª’åˆç³»çµ± (é–‹ç™¼è€…)</div>

    <div class="container">
        <div id="admin-ui" class="admin-box">
            <h3 style="color:#00e676;">ğŸ”’ é–‹ç™¼è€…å°å¸³èˆ‡æ¬Šé™ä¸­å¿ƒ</h3>
            <div id="admin-order-list"></div>
            <button onclick="document.getElementById('admin-ui').style.display='none'" style="width:100%; background:#444; color:#fff; border:none; padding:10px; border-radius:5px;">é—œé–‰æ§åˆ¶å°</button>
        </div>

        <div id="main-flow">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-role" id="btn-p" onclick="selectRole('passenger')">ä¹˜å®¢ç«¯</button>
                <button class="btn-role" id="btn-d" onclick="selectRole('driver')">å¸æ©Ÿç«¯</button>
            </div>

            <div id="driver-register" style="display:none;" class="card">
                <h3 style="color:#00e676;">å¸æ©Ÿå¯¦åèˆ‡æ”¶æ¬¾èªè­‰</h3>
                <input type="text" id="d-name" placeholder="å…¨å">
                <input type="text" id="d-car" placeholder="è»Šç‰Œ">
                <input type="text" id="d-bank" placeholder="åœ‹æ³°ä¸–è¯(013) å¸³è™Ÿ">
                <input type="text" id="d-jko" placeholder="è¡—å£æ”¯ä»˜(396) å¸³è™Ÿ">
                <input type="file" id="d-img" accept="image/*">
                <button class="btn-main" onclick="saveDriverProfile()">å„²å­˜ä¸¦æ¥å–®</button>
            </div>

            <div id="passenger-ui" style="display:none;">
                <div class="payment-info">
                    <b>ğŸ’° å®˜æ–¹åŒ¯æ¬¾å¸³è™Ÿ (Jasper æŒ‡å®š)</b><br>
                    åœ‹æ³°ä¸–è¯(013): 125506256272<br>
                    è¡—å£æ”¯ä»˜(396): 909191462<br>
                    <small>* è«‹æ–¼ä¸‹å–®å¾Œ 10 åˆ†é˜å…§å®ŒæˆåŒ¯æ¬¾ä»¥åˆ©å°å¸³</small>
                </div>
                <div class="card">
                    <input type="text" id="p-start" placeholder="ğŸ“ èµ·é»">
                    <input type="text" id="p-end" placeholder="ğŸ ç›®çš„åœ°">
                    <button class="btn-main" onclick="postOrder()">ç™¼é€å«è»Š (å¾…é–‹ç™¼è€…å°å¸³)</button>
                </div>
            </div>

            <div id="driver-ui" style="display:none;"><div id="order-list">ç­‰å¾…å°å¸³å–®...</div></div>

            <div id="chat-section" style="display:none;">
                <div id="status-display" class="card" style="text-align:center; color:#00e676; font-weight:bold;"></div>
                <div id="p-verify-box" class="card" style="display:none;">
                    <label>ğŸ“¸ ä¸Šè»Šç…§ç‰‡æ ¸å¯¦ (æ‹è»Šç‰Œèˆ‡æ™‚é–“)</label>
                    <input type="file" id="p-verify-img" accept="image/*" capture="camera">
                    <button class="btn-main" onclick="passengerVerify()">ç¢ºèªä¸Šè»Šå›å‚³</button>
                </div>
                <button onclick="closeChat()" style="background:#444; color:#fff; width:100%; border:none; padding:10px; border-radius:8px; margin-bottom:10px;">â¬…ï¸ è¿”å›</button>
                <div class="card">
                    <div id="chat-box"></div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="chat-input" placeholder="è¨Šæ¯...">
                        <button style="background:#2979ff; border:none; color:white; border-radius:8px; padding:0 15px;" onclick="sendMessage()">ç™¼é€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68",
            authDomain: "jasper-taxi.firebaseapp.com",
            projectId: "jasper-taxi",
            storageBucket: "jasper-taxi.firebasestorage.app",
            messagingSenderId: "558407272439",
            appId: "1:558407272439:web:e48abaae404530a75c90f2",
            measurementId: "G-X8HP1JRZYN",
            databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let userId = localStorage.getItem('jasper_user_id') || 'u' + Date.now();
        localStorage.setItem('jasper_user_id', userId);

        let currentRole = '', activeOrderId = null, clickCount = 0;
        const ADMIN_PASS = "Jasper888"; // <--- æ‚¨å¯ä»¥åœ¨æ­¤ä¿®æ”¹å¯†ç¢¼

        function triggerAdmin() {
            clickCount++;
            if(clickCount >= 5) {
                const pass = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡æˆæ¬Šå¯†ç¢¼ï¼š");
                if(pass === ADMIN_PASS) {
                    document.getElementById('admin-ui').style.display = 'block';
                    listenAdmin();
                } else {
                    alert("æ¬Šé™ä¸è¶³ï¼Œå¯†ç¢¼éŒ¯èª¤ï¼");
                }
                clickCount = 0;
            }
        }

        // ç®¡ç†å“¡å°å¸³èˆ‡æ’¥æ¬¾é‚è¼¯
        function listenAdmin() {
            db.ref('orders').on('value', snap => {
                const list = document.getElementById('admin-order-list'); list.innerHTML = '';
                snap.forEach(child => {
                    const o = child.val();
                    list.innerHTML += `
                        <div class="card" style="font-size:12px; border-left: 4px solid #00e676;">
                            <b>ç‹€æ…‹:</b> ${o.status}<br>
                            <b>å¸æ©Ÿ:</b> ${o.dName || 'ç„¡'} (${o.dBank || 'æœªå¡«'})<br>
                            <b>è·¯å¾‘:</b> ${o.start} â” ${o.end}<br>
                            ${o.status === 'waiting' ? `<button onclick="adminAction('${child.key}', 'pay_confirmed')" style="background:#00e676; padding:5px; border:none; border-radius:3px;">âœ… ä¹˜å®¢å·²åŒ¯æ¬¾</button>` : ''}
                            ${o.status === 'finished' ? `<button onclick="adminAction('${child.key}', 'settled')" style="background:#2979ff; color:white; padding:5px; border:none; border-radius:3px;">ğŸ’° æ’¥æ¬¾çµ¦å¸æ©Ÿ</button>` : ''}
                            <button onclick="adminDelete('${child.key}')" style="background:#ff5252; color:white; padding:5px; border:none; border-radius:3px; margin-left:5px;">åˆªé™¤</button>
                        </div>`;
                });
            });
        }

        function adminAction(id, newStatus) { db.ref('orders/' + id).update({ status: newStatus }); alert("æ“ä½œæˆåŠŸï¼"); }
        function adminDelete(id) { if(confirm("åˆªé™¤ï¼Ÿ")) db.ref('orders/' + id).remove(); }

        // å…¶é¤˜é€šè¨Šèˆ‡èº«åˆ†é‚è¼¯ä¿æŒèˆ‡å‰ä¸€ç‰ˆæœ¬ä¸€è‡´ï¼Œç¢ºä¿å®Œæ•´æ€§
        function selectRole(role) {
            currentRole = role;
            const profile = localStorage.getItem('driver_profile');
            if(role === 'driver' && !profile) { document.getElementById('driver-register').style.display='block'; document.getElementById('passenger-ui').style.display='none'; return; }
            document.getElementById('driver-register').style.display='none';
            document.getElementById('passenger-ui').style.display= role==='passenger'?'block':'none';
            document.getElementById('driver-ui').style.display= role==='driver'?'block':'none';
            if(role==='driver') listenOrders();
        }

        function saveDriverProfile() {
            const name = document.getElementById('d-name').value, car = document.getElementById('d-car').value;
            const bank = document.getElementById('d-bank').value, jko = document.getElementById('d-jko').value;
            const file = document.getElementById('d-img').files[0];
            if(!name || !car || !file || !bank) return alert("è«‹å®Œæ•´å¡«å¯«å§“åã€è»Šç‰Œã€éŠ€è¡Œèˆ‡ç…§ç‰‡");
            const reader = new FileReader(); reader.onload = (e) => {
                localStorage.setItem('driver_profile', JSON.stringify({name, car, bank, jko, img: e.target.result}));
                selectRole('driver');
            }; reader.readAsDataURL(file);
        }

        function postOrder() {
            const s = document.getElementById('p-start').value, e = document.getElementById('p-end').value;
            if(!s || !e) return alert("åœ°é»å¿…å¡«");
            const ref = db.ref('orders').push();
            activeOrderId = ref.key;
            ref.set({ start: s, end: e, status: 'waiting', pId: userId, createTime: Date.now() });
            loadOrder(activeOrderId);
        }

        function listenOrders() {
            db.ref('orders').on('value', snap => {
                const list = document.getElementById('order-list'); list.innerHTML = '';
                snap.forEach(child => {
                    const o = child.val();
                    if(o.status === 'pay_confirmed') {
                        list.innerHTML += `<div class="card">ğŸ“ ${o.start} â” ${o.end}<br><button class="btn-main" onclick="acceptOrder('${child.key}')">å·²å°å¸³ï¼Œæˆ‘è¦æ¶å–®</button></div>`;
                    }
                });
            });
        }

        function acceptOrder(id) {
            const p = JSON.parse(localStorage.getItem('driver_profile'));
            db.ref('orders/' + id).transaction(order => {
                if(order && order.status === 'pay_confirmed') {
                    order.status = 'accepted'; order.dId = userId; order.dName = p.name; order.dCar = p.car; order.dBank = p.bank; order.dJko = p.jko;
                    return order;
                }
            }, (err, committed) => { if(committed) loadOrder(id); });
        }

        function loadOrder(id) {
            activeOrderId = id; document.getElementById('main-flow').style.display='none'; document.getElementById('chat-section').style.display='block';
            listenChat(id);
        }

        function listenChat(id) {
            db.ref('orders/' + id).on('value', snap => {
                const o = snap.val(); if(!o) return;
                document.getElementById('status-display').innerText = `ã€ç³»çµ±ç‹€æ…‹ï¼š${o.status}ã€‘`;
                if(o.status === 'accepted' && currentRole === 'passenger') document.getElementById('p-verify-box').style.display = 'block';
                else document.getElementById('p-verify-box').style.display = 'none';
                if(o.status === 'verified' && currentRole === 'driver') {
                    document.getElementById('status-display').innerHTML += `<br><button class="btn-main" onclick="finishOrder()">æŠµé”ç›®çš„åœ° (çµæŸè¡Œç¨‹)</button>`;
                }
            });
            db.ref('messages/' + id).on('value', snap => {
                const box = document.getElementById('chat-box'); box.innerHTML = '';
                snap.forEach(m => { const d = m.val(); box.innerHTML += `<div style="margin-bottom:8px; text-align:${d.role==='driver'?'right':'left'}"><span style="background:${d.role==='driver'?'#00e676':'#333'}; padding:5px; border-radius:5px; color:${d.role==='driver'?'#000':'#fff'}">${d.text}</span></div>`; });
                box.scrollTop = box.scrollHeight;
            });
        }

        function passengerVerify() {
            const f = document.getElementById('p-verify-img').files[0];
            if(!f) return alert("æ‹ç…§æ‰å…·æ³•å¾‹èˆ‡å°å¸³æ•ˆç›Š");
            const r = new FileReader(); r.onload = (e) => {
                db.ref('orders/' + activeOrderId).update({ status: 'verified', pImg: e.target.result,ä¸Šè»Šæ™‚é–“: Date.now() });
                alert("å·²ä¸Šå‚³æ ¸å¯¦ç…§ç‰‡ï¼");
            }; r.readAsDataURL(f);
        }

        function finishOrder() { db.ref('orders/' + activeOrderId).update({ status: 'finished', ä¸‹è»Šæ™‚é–“: Date.now() }); alert("è¡Œç¨‹çµæŸï¼Œé–‹ç™¼è€…å°‡æ ¸å°ä¸¦æ’¥æ¬¾ã€‚"); }
        function sendMessage() {
            const t = document.getElementById('chat-input').value;
            if(t) { db.ref('messages/' + activeOrderId).push({ role: currentRole, text: t, time: Date.now() }); document.getElementById('chat-input').value = ''; }
        }
        function closeChat() { document.getElementById('main-flow').style.display='block'; document.getElementById('chat-section').style.display='none'; }
    </script>
</body>
</html>
