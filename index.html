<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± (é»‘é‡‘ç‰ˆ)</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        /* --- åŸæœ‰é»‘é‡‘è¦–è¦ºè¨­è¨ˆ --- */
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; padding-bottom: 20px; }
        h2 { margin: 0; padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; font-size: 20px; letter-spacing: 1px; }
        
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        /* è§’è‰²åˆ‡æ›æŒ‰éˆ• */
        .role-switcher { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-role { flex: 1; padding: 15px; border: 1px solid #444; background: #2c2c2c; color: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-role.active { background: #00e676; color: #000; border-color: #00e676; }

        /* è¼¸å…¥èˆ‡é€šç”¨æŒ‰éˆ• */
        label { color: #00e676; font-size: 14px; font-weight: bold; margin-bottom: 8px; display: block; }
        input { width: 100%; padding: 14px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        input:focus { border-color: #00e676; }
        .btn-main { width: 100%; padding: 16px; background: linear-gradient(135deg, #00e676, #00c853); color: #000; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); }

        /* èŠå¤©å€å¡Š */
        #chat-section { display: none; }
        #chat-box { height: 300px; overflow-y: auto; background: #121212; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 14px; line-height: 1.4; }
        .msg-driver { align-self: flex-end; background: #00e676; color: #000; border-bottom-right-radius: 2px; }
        .msg-passenger { align-self: flex-start; background: #333; color: #fff; border-bottom-left-radius: 2px; }
        
        .chat-input-group { display: flex; gap: 10px; }
        .btn-send { width: 80px; background: #2979ff; border: none; color: white; border-radius: 8px; font-weight: bold; }

        /* æ¶å–®é–ƒçˆæ•ˆæœ */
        .order-card { border-left: 5px solid #00e676; }
        .btn-grab { background: #ff5252; color: white; border: none; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸš• Jasper æ™ºæ…§åª’åˆç³»çµ±</h2>

    <div class="container">
        <div id="role-selection" class="role-switcher">
            <button class="btn-role" onclick="setRole('passenger')">æˆ‘æ˜¯ä¹˜å®¢ (ç™¼å–®)</button>
            <button class="btn-role" onclick="setRole('driver')">æˆ‘æ˜¯å¸æ©Ÿ (æ¶å–®)</button>
        </div>

        <div id="passenger-ui" style="display:none;">
            <div class="card">
                <label>ğŸ“ èµ·é»</label>
                <input type="text" id="start-point" placeholder="ä¾‹å¦‚ï¼šæ–°èŠå€æ˜Œå¹³è¡—326è™Ÿ">
                <label>ğŸ ç›®çš„åœ°</label>
                <input type="text" id="end-point" placeholder="ä¾‹å¦‚ï¼šæ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ">
                <button class="btn-main" onclick="postOrder()">ç™¼é€æ¶å–®éœ€æ±‚</button>
            </div>
        </div>

        <div id="driver-ui" style="display:none;">
            <h3 style="color:#888; font-size:14px; margin-bottom:10px;">ğŸ“¡ å³æ™‚æ¶å–®é›·é” (å…¨å€)</h3>
            <div id="order-list">
                <div style="text-align:center; padding:20px; color:#555;">ç­‰å¾…è¨‚å–®ä¸­...</div>
            </div>
        </div>

        <div id="chat-section">
            <div class="card">
                <label>ğŸ’¬ å³æ™‚å°è©± (å¾Œå°ç›£æ§ä¸­)</label>
                <div id="chat-box"></div>
                <div class="chat-input-group">
                    <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." style="margin-bottom:0;">
                    <button class="btn-send" onclick="sendMessage()">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68",
            authDomain: "jasper-taxi.firebaseapp.com",
            projectId: "jasper-taxi",
            storageBucket: "jasper-taxi.firebasestorage.app",
            messagingSenderId: "558407272439",
            appId: "1:558407272439:web:e48abaae404530a75c90f2",
            measurementId: "G-X8HP1JRZYN",
            databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentRole = '';
        let activeOrderId = null;

        function setRole(role) {
            currentRole = role;
            document.querySelectorAll('.btn-role').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('passenger-ui').style.display = role === 'passenger' ? 'block' : 'none';
            document.getElementById('driver-ui').style.display = role === 'driver' ? 'block' : 'none';
            
            if(role === 'driver') listenForOrders();
        }

        function postOrder() {
            const start = document.getElementById('start-point').value;
            const end = document.getElementById('end-point').value;
            if(!start || !end) return alert("è«‹å¡«å¯«èµ·è¨–åœ°é»");

            const newOrderRef = db.ref('orders').push();
            activeOrderId = newOrderRef.key;
            newOrderRef.set({
                start: start,
                end: end,
                status: 'waiting',
                createTime: Date.now()
            });
            
            alert("è¨‚å–®å·²ç™¼é€ï¼Œè«‹ç­‰å¾…å¸æ©Ÿæ¶å–®...");
            listenForChat(activeOrderId);
        }

        function listenForOrders() {
            db.ref('orders').on('value', (snapshot) => {
                const orders = snapshot.val();
                const listDiv = document.getElementById('order-list');
                listDiv.innerHTML = '';

                let hasOrder = false;
                for(let id in orders) {
                    if(orders[id].status === 'waiting') {
                        hasOrder = true;
                        const item = document.createElement('div');
                        item.className = 'card order-card';
                        item.innerHTML = `
                            <div style="margin-bottom:10px;">
                                <div style="font-size:12px; color:#888;">æ–°å–®æé†’</div>
                                <div style="margin:5px 0;">ğŸ“ ${orders[id].start}</div>
                                <div style="margin:5px 0;">ğŸ ${orders[id].end}</div>
                            </div>
                            <button class="btn-grab" onclick="acceptOrder('${id}')">ç«‹å³æ¶å–®</button>
                        `;
                        listDiv.appendChild(item);
                    }
                }
                if(!hasOrder) listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#555;">ç›®å‰æ²’æœ‰å¾…æ¥å–®</div>';
            });
        }

        function acceptOrder(id) {
            db.ref('orders/' + id).transaction((order) => {
                if (order && order.status === 'waiting') {
                    order.status = 'accepted';
                    return order;
                }
                return; 
            }, (error, committed) => {
                if (committed) {
                    activeOrderId = id;
                    alert("æ¶å–®æˆåŠŸï¼è«‹é–‹å§‹å°è©±");
                    listenForChat(id);
                } else {
                    alert("è¨‚å–®å·²è¢«æ¶èµ°å›‰ï¼");
                }
            });
        }

        function listenForChat(orderId) {
            document.getElementById('chat-section').style.display = 'block';
            
            db.ref('messages/' + orderId).on('value', (snapshot) => {
                const msgs = snapshot.val();
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                for(let mId in msgs) {
                    const div = document.createElement('div');
                    const roleClass = msgs[mId].role === 'driver' ? 'msg-driver' : 'msg-passenger';
                    div.className = `msg ${roleClass}`;
                    div.innerText = msgs[mId].text;
                    box.appendChild(div);
                }
                box.scrollTop = box.scrollHeight;
            });
        }

        function sendMessage() {
            const text = document.getElementById('chat-input').value;
            if(!text || !activeOrderId) return;

            db.ref('messages/' + activeOrderId).push({
                role: currentRole,
                text: text,
                time: Date.now()
            });
            document.getElementById('chat-input').value = '';
        }
    </script>
</body>
</html>
