<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - é›™å‘è©•åƒ¹ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        .header { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; cursor: pointer; user-select: none; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        .btn-main { width: 100%; padding: 18px; background: #00e676; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        input, textarea { width: 100%; padding: 14px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
        
        /* æ˜Ÿç­‰æ¨£å¼ */
        .star-rating { display: flex; justify-content: center; gap: 10px; margin: 15px 0; font-size: 30px; }
        .star { cursor: pointer; color: #444; }
        .star.selected { color: #ffeb3b; }
        .star-display { color: #ffeb3b; font-size: 14px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #1e1e1e; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; border: 1px solid #00e676; }
    </style>
</head>
<body>

    <div class="header" onclick="triggerAdmin()">ğŸš• Jasper æ™ºæ…§åª’åˆç³»çµ± (é–‹ç™¼è€…)</div>

    <div class="container">
        <div id="rating-modal" class="modal">
            <div class="modal-content">
                <h3 id="rating-title">è¡Œç¨‹çµæŸï¼è©•åˆ†</h3>
                <div class="star-rating" id="star-input">
                    <span class="star" onclick="setStar(1)">â˜…</span>
                    <span class="star" onclick="setStar(2)">â˜…</span>
                    <span class="star" onclick="setStar(3)">â˜…</span>
                    <span class="star" onclick="setStar(4)">â˜…</span>
                    <span class="star" onclick="setStar(5)">â˜…</span>
                </div>
                <button class="btn-main" onclick="submitRating()">é€å‡ºè©•åˆ†</button>
            </div>
        </div>

        <div id="main-flow">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-role" id="btn-p" style="flex:1; padding:15px;" onclick="selectRole('passenger')">ä¹˜å®¢ç«¯</button>
                <button class="btn-role" id="btn-d" style="flex:1; padding:15px;" onclick="selectRole('driver')">å¸æ©Ÿç«¯</button>
            </div>

            <div id="passenger-ui" style="display:none;">
                <div class="card" style="padding:20px;">
                    <input type="tel" id="p-phone" placeholder="ğŸ“ æ‚¨çš„è¯çµ¡é›»è©±">
                    <input type="text" id="p-start" placeholder="ğŸ“ èµ·é» (è©³ç´°åœ°å€)" onblur="calculateFare()">
                    <input type="text" id="p-end" placeholder="ğŸ ç›®çš„åœ°" onblur="calculateFare()">
                    <div id="fare-display" style="display:none; color:#ffeb3b; font-size:13px; margin-bottom:15px;"></div>
                    <input type="number" id="p-fare" placeholder="ğŸ’µ åŒ¯æ¬¾ç¸½é¡" readonly>
                    <button class="btn-main" onclick="postOrder()">ç™¼é€å«è»Šéœ€æ±‚</button>
                </div>
            </div>

            <div id="driver-ui" style="display:none;">
                <div id="order-list">æœå°‹ä¸­...</div>
            </div>

            <div id="chat-section" style="display:none;">
                <div id="match-display" class="card" style="text-align:center; padding:15px;"></div>
                <button onclick="closeChat()" style="background:#444; color:#fff; width:100%; border:none; padding:12px; border-radius:8px; margin-bottom:10px;">â¬…ï¸ è¿”å›</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { /* æ‚¨çš„ Firebase é…ç½®ä¿æŒä¸è®Š */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let selectedStar = 0, currentRatingTarget = '';

        // --- æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—æ˜Ÿç­‰ ---
        function getAverageRating(id, type, elementId) {
            db.ref(`ratings/${type}/${id}`).once('value', snap => {
                const data = snap.val();
                if (data) {
                    const avg = (data.totalStars / data.count).toFixed(1);
                    document.getElementById(elementId).innerHTML = `â­ ${avg} (${data.count}æ¬¡è©•åƒ¹)`;
                } else {
                    document.getElementById(elementId).innerHTML = `â­ æ–°ç”¨æˆ¶`;
                }
            });
        }

        // --- å¸æ©Ÿçœ‹å–®æ™‚æœƒçœ‹åˆ°ä¹˜å®¢æ˜Ÿç­‰ ---
        function listenOrders() {
            db.ref('orders').on('value', snap => {
                const list = document.getElementById('order-list'); list.innerHTML = '';
                snap.forEach(child => {
                    const o = child.val();
                    if(o.status === 'pay_confirmed') {
                        const orderDiv = document.createElement('div');
                        orderDiv.className = 'card';
                        orderDiv.style.padding = '15px';
                        const ratingId = `rate-p-${child.key}`;
                        orderDiv.innerHTML = `
                            ğŸ“ ${o.start} â” ${o.end}<br>
                            ğŸ’µ ç¸½é¡: $${o.fare}<br>
                            ğŸ‘¤ ä¹˜å®¢è©•åƒ¹: <span id="${ratingId}" class="star-display">è®€å–ä¸­...</span><br>
                            <button class="btn-main" style="margin-top:10px;" onclick="acceptOrder('${child.key}')">æ¶å–®</button>
                        `;
                        list.appendChild(orderDiv);
                        getAverageRating(o.pPhone, 'passengers', ratingId);
                    }
                });
            });
        }

        // --- ä¹˜å®¢çœ‹å°è©±æ™‚çœ‹åˆ°å¸æ©Ÿæ˜Ÿç­‰ ---
        function listenChatData(id) {
            db.ref('orders/' + id).on('value', snap => {
                const o = snap.val(); if(!o) return;
                const d = document.getElementById('match-display');
                if(currentRole === 'driver') {
                    d.innerHTML = `è¡Œç¨‹é¡åº¦: $${o.fare}`;
                } else {
                    const rateId = `rate-d-${id}`;
                    d.innerHTML = `
                        å¸æ©Ÿ: ${o.dName || 'å°å¸³ä¸­'}<br>
                        è»Šç‰Œ: ${o.dCar || ''}<br>
                        æ˜Ÿç­‰: <span id="${rateId}" class="star-display">è®€å–ä¸­...</span>
                    `;
                    if(o.dId) getAverageRating(o.dId, 'drivers', rateId);
                }
                
                // è¡Œç¨‹çµæŸè‡ªå‹•è·³è©•åˆ†
                if(o.status === 'settled' && !localStorage.getItem(`rated_${id}`)) {
                    openRatingModal(id, o);
                }
            });
        }

        // --- è©•åˆ†åŠŸèƒ½ ---
        function setStar(n) {
            selectedStar = n;
            const stars = document.querySelectorAll('.star');
            stars.forEach((s, i) => s.classList.toggle('selected', i < n));
        }

        function openRatingModal(orderId, orderObj) {
            activeOrderId = orderId;
            currentRatingTarget = (currentRole === 'passenger') ? 
                { type: 'drivers', id: orderObj.dId, title: "è©•åˆ†å¸æ©Ÿæœå‹™" } : 
                { type: 'passengers', id: orderObj.pPhone, title: "è©•åˆ†ä¹˜å®¢å“è³ª" };
            
            document.getElementById('rating-title').innerText = currentRatingTarget.title;
            document.getElementById('rating-modal').style.display = 'flex';
        }

        function submitRating() {
            if(selectedStar === 0) return alert("è«‹é¸æ“‡æ˜Ÿç­‰");
            const target = currentRatingTarget;
            
            db.ref(`ratings/${target.type}/${target.id}`).transaction(curr => {
                if (!curr) return { totalStars: selectedStar, count: 1 };
                return {
                    totalStars: curr.totalStars + selectedStar,
                    count: curr.count + 1
                };
            }).then(() => {
                localStorage.setItem(`rated_${activeOrderId}`, true);
                document.getElementById('rating-modal').style.display = 'none';
                alert("è©•åˆ†æˆåŠŸï¼");
                closeChat();
            });
        }
        
        /* å…¶ä»–æ ¸å¿ƒé‚è¼¯ (calculateFare, postOrder, triggerAdmin) ä¿æŒä¸è®Š */
    </script>
</body>
</html>
