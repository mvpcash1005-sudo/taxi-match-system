<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jasper æ•¸ç†æ•™è‚² - æ™ºæ…§æ¥å–®èˆ‡å³æ™‚é€šè¨Šç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        #chat-box { display: none; border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 10px; background: #fff; margin-top: 10px; }
        .msg { margin-bottom: 8px; padding: 5px; border-radius: 4px; }
        .msg-driver { background: #e3f2fd; text-align: right; }
        .msg-passenger { background: #f1f8e9; text-align: left; }
    </style>
</head>
<body>

    <h2>ğŸš• Jasper åª’åˆç³»çµ± (å…¨å€æ¨¡å¼)</h2>
    
    <div id="role-selection">
        <button onclick="setRole('passenger')">æˆ‘æ˜¯ä¹˜å®¢</button>
        <button onclick="setRole('driver')">æˆ‘æ˜¯å¸æ©Ÿ</button>
    </div>

    <div id="passenger-ui" style="display:none;">
        <h3>ç™¼é€éœ€æ±‚</h3>
        <input type="text" id="start-point" placeholder="è¼¸å…¥èµ·é»">
        <input type="text" id="end-point" placeholder="è¼¸å…¥ç›®çš„åœ°">
        <button onclick="postOrder()">ç™¼é€æ¶å–®éœ€æ±‚</button>
    </div>

    <div id="driver-ui" style="display:none;">
        <h3>å¾…æ¥è¨‚å–® (å…¨å€)</h3>
        <div id="order-list">ç­‰å¾…è¨‚å–®ä¸­...</div>
    </div>

    <div id="chat-section" style="display:none;" class="card">
        <h3>ğŸ’¬ å³æ™‚å°è©± (å¾Œå°ç›£æ§ä¸­)</h3>
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯...">
        <button onclick="sendMessage()">ç™¼é€</button>
    </div>

    <script>
        // --- å‹™å¿…åœ¨æ­¤è™•æ›¿æ›æ‚¨çš„ Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68",
            authDomain: "jasper-taxi.firebaseapp.com",
            projectId: "jasper-taxi",
            storageBucket: "jasper-taxi.firebasestorage.app",
            messagingSenderId: "558407272439",
            appId: "1:558407272439:web:e48abaae404530a75c90f2",
            measurementId: "G-X8HP1JRZYN",
            databaseURL:"https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentRole = '';
        let activeOrderId = null;

        function setRole(role) {
            currentRole = role;
            document.getElementById('role-selection').style.display = 'none';
            document.getElementById(role + '-ui').style.display = 'block';
            if(role === 'driver') listenForOrders();
        }

        // ä¹˜å®¢ç™¼å–®
        function postOrder() {
            const start = document.getElementById('start-point').value;
            const end = document.getElementById('end-point').value;
            if(!start || !end) return alert("è«‹å¡«å¯«åœ°é»");

            const newOrderRef = db.ref('orders').push();
            activeOrderId = newOrderRef.key;
            newOrderRef.set({
                start: start,
                end: end,
                status: 'waiting',
                createTime: Date.now()
            });
            
            alert("è¨‚å–®å·²ç™¼é€ï¼Œç­‰å¾…å¸æ©Ÿæ¶å–®...");
            listenForChat(activeOrderId);
        }

        // å¸æ©Ÿç›£è½æ‰€æœ‰è¨‚å–® (ç§»é™¤è·é›¢éæ¿¾)
        function listenForOrders() {
            db.ref('orders').on('value', (snapshot) => {
                const orders = snapshot.val();
                const listDiv = document.getElementById('order-list');
                listDiv.innerHTML = '';

                for(let id in orders) {
                    if(orders[id].status === 'waiting') {
                        const item = document.createElement('div');
                        item.className = 'card';
                        item.innerHTML = `
                            <strong>å¾ï¼š</strong> ${orders[id].start}<br>
                            <strong>åˆ°ï¼š</strong> ${orders[id].end}<br>
                            <button onclick="acceptOrder('${id}')">ç«‹å³æ¶å–®</button>
                        `;
                        listDiv.appendChild(item);
                    }
                }
            });
        }

        // æ¶å–®é‚è¼¯
        function acceptOrder(id) {
            db.ref('orders/' + id).transaction((order) => {
                if (order && order.status === 'waiting') {
                    order.status = 'accepted';
                    return order;
                }
                return; 
            }, (error, committed) => {
                if (committed) {
                    activeOrderId = id;
                    alert("æ¶å–®æˆåŠŸï¼ç¾åœ¨å¯ä»¥èˆ‡ä¹˜å®¢å°è©±");
                    listenForChat(id);
                } else {
                    alert("æ‰‹é€Ÿå¤ªæ…¢ï¼Œè¢«æ¶èµ°äº†ï¼");
                }
            });
        }

        // ç›£è½å°è©±å…§å®¹
        function listenForChat(orderId) {
            document.getElementById('chat-section').style.display = 'block';
            document.getElementById('chat-box').style.display = 'block';
            
            db.ref('messages/' + orderId).on('value', (snapshot) => {
                const msgs = snapshot.val();
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                for(let mId in msgs) {
                    const div = document.createElement('div');
                    div.className = `msg msg-${msgs[mId].role}`;
                    div.innerText = `${msgs[mId].role === 'driver' ? 'å¸æ©Ÿ' : 'ä¹˜å®¢'}: ${msgs[mId].text}`;
                    box.appendChild(div);
                }
                box.scrollTop = box.scrollHeight;
            });
        }

        // ç™¼é€è¨Šæ¯
        function sendMessage() {
            const text = document.getElementById('chat-input').value;
            if(!text || !activeOrderId) return;

            db.ref('messages/' + activeOrderId).push({
                role: currentRole,
                text: text,
                time: Date.now()
            });
            document.getElementById('chat-input').value = '';
        }
    </script>
</body>
</html>
