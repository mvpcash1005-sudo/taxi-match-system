<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - 2026 å…¨åŠŸèƒ½ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        .header { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; cursor: pointer; user-select: none; }
        .container { padding: 15px; max-width: 1000px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-role { flex: 1; padding: 15px; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-role.active { background: #00e676; color: #000; }
        input, select { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 15px; background: #00e676; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        /* ç®¡ç†å“¡ä»‹é¢ */
        .admin-box { display: none; margin-top: 10px; border: 2px solid #00e676; padding: 10px; border-radius: 12px; background: #000; }
        .admin-nav { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #333; margin-bottom: 10px; }
        .tab-btn { padding: 8px 12px; background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 12px; }
        .tab-btn.active { background: #00e676; color: #000; }
        
        /* åœ–ç‰‡æ”¾å¤§æª¢è¦– (ä¸è·³é é¢) */
        #img-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 20000; justify-content: center; align-items: center; }
        #img-viewer img { max-width: 95%; max-height: 90%; border: 2px solid #00e676; }
        .img-thumb { width: 45px; height: 45px; object-fit: cover; border: 1px solid #555; margin-right: 3px; cursor: pointer; }

        /* è¡¨æ ¼èˆ‡æ–‡å­— */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: left; vertical-align: middle; }
        th { background: #222; color: #00e676; }
        .money { color: #00e676; font-weight: bold; }
    </style>
</head>
<body>

    <div id="img-viewer" onclick="this.style.display='none'">
        <img id="viewer-img" src="">
        <p style="position: absolute; bottom: 30px; color: #00e676;">é»æ“Šä»»æ„è™•é—œé–‰å¤§åœ–</p>
    </div>

    <div class="header" onclick="triggerAdmin()">ğŸš• Jasper æ™ºæ…§åª’åˆç®¡ç†ç¸½ç«¯</div>

    <div class="container">
        <div id="admin-ui" class="admin-box">
            <div class="admin-nav">
                <button class="tab-btn active" id="btn-tab-pay" onclick="switchTab('payment')">ğŸ’° åŒ¯æ¬¾æ”¾å–®</button>
                <button class="tab-btn" id="btn-tab-drv" onclick="switchTab('verify')">ğŸ“„ å¸æ©Ÿå¯©æ ¸</button>
                <button class="tab-btn" id="btn-tab-rep" onclick="switchTab('report')">ğŸ“Š æ¯æ—¥å ±è¡¨</button>
                <button class="tab-btn" id="btn-tab-mem" onclick="switchTab('members')">ğŸ‘¥ å¸æ©ŸåéŒ„</button>
                <button onclick="document.getElementById('admin-ui').style.display='none'" style="margin-left: auto; color: red; background: none; border: none;">é—œé–‰</button>
            </div>
            <div id="admin-content"></div>
        </div>

        <div id="main-flow">
            <div id="p-status-box" style="display:none; background:#004d40; padding:15px; border-radius:10px; border:1px solid #00e676; margin-bottom:15px;">
                <h3 style="margin:0 0 5px 0; font-size:16px;">ğŸ” è¨‚å–®é€²åº¦</h3>
                <div id="p-status-text"></div>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-role active" id="btn-p" onclick="selectRole('passenger')">ä¹˜å®¢ç«¯</button>
                <button class="btn-role" id="btn-d" onclick="selectRole('driver')">å¸æ©Ÿç«¯</button>
            </div>

            <div id="passenger-ui">
                <div class="card" style="background:#004d40; text-align:center; font-size:14px; border-color:#00e676;">
                    <b>ğŸ’ Jasper æ”¶æ¬¾ (å…ˆåŒ¯æ¬¾å¾Œå¯©æ ¸)</b><br>
                    åœ‹æ³°(013): 125506256272 | è¡—å£: 909191462
                </div>
                <div class="card">
                    <input type="datetime-local" id="p-book-time">
                    <input type="tel" id="p-phone" placeholder="ğŸ“ æ‚¨çš„é›»è©±">
                    <input type="text" id="p-start" placeholder="ğŸ“ èµ·é»">
                    <input type="text" id="p-end" placeholder="ğŸ ç›®çš„åœ°">
                    <input type="number" id="p-fare" placeholder="ğŸ’µ å»ºè­°åŒ¯æ¬¾ç¸½é¡">
                    <button class="btn-main" onclick="postOrder()">ç™¼é€è¨‚å–®ä¸¦æ ¸å¸³</button>
                </div>
            </div>

            <div id="driver-register" style="display:none;" class="card">
                <h3 style="color:#00e676; margin-top:0;">å¸æ©Ÿå¯¦åè¨»å†Š (è£œé½Š 6 è­‰)</h3>
                <input type="text" id="d-name" placeholder="å§“å">
                <input type="tel" id="d-phone" placeholder="é›»è©±">
                <input type="text" id="d-car" placeholder="è»Šç‰Œ">
                <input type="text" id="d-bank" placeholder="æ”¶æ¬¾å¸³è™Ÿ (åœ‹æ³°/è¡—å£)">
                <small style="color:#00e676;">ğŸ“¸ è«‹ä¾åºä¸Šå‚³ï¼šè»Šç‰Œã€èº«åˆ†è­‰æ­£/åã€åŸ·æ¥­è­‰æ­£/å</small>
                <input type="file" multiple accept="image/*" onchange="handleMultipleUpload(this)">
                <div id="upload-previews" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div>
                <button class="btn-main" style="margin-top:15px;" onclick="saveDriverProfile()">æäº¤è³‡æ–™ä¸¦ç­‰å¾…å¯©æ ¸</button>
            </div>

            <div id="driver-ui" style="display:none;"><div id="order-list">æœå°‹è¡Œç¨‹ä¸­...</div></div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68", databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ADMIN_PASS = "Jasper888";
        let userId = localStorage.getItem('jasper_user_id') || 'u' + Date.now();
        localStorage.setItem('jasper_user_id', userId);
        let clickCount = 0, uploadedImages = [];

        // --- ç®¡ç†å“¡è§¸ç™¼èˆ‡åˆ‡æ› ---
        function triggerAdmin() {
            clickCount++;
            if(clickCount >= 5) {
                const p = prompt("Jasper è€å¸«ï¼Œè«‹è¼¸å…¥å¯†ç¢¼ï¼š");
                if(p === ADMIN_PASS) { document.getElementById('admin-ui').style.display='block'; switchTab('payment'); }
                clickCount = 0;
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(tab==='payment') { document.getElementById('btn-tab-pay').classList.add('active'); loadAdminOrders(); }
            if(tab==='verify') { document.getElementById('btn-tab-drv').classList.add('active'); loadAdminVerify(); }
            if(tab==='report') { document.getElementById('btn-tab-rep').classList.add('active'); loadDailyReport(); }
            if(tab==='members') { document.getElementById('btn-tab-mem').classList.add('active'); loadAdminMembers(); }
        }

        // --- 1. æ¯æ—¥å°å¸³å ±è¡¨ä¿®å¾© ---
        function loadDailyReport() {
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];
            db.ref('orders').once('value', snap => {
                const map = {}; let grandTotal = 0;
                snap.forEach(c => {
                    const o = c.val();
                    const oDate = new Date(o.createTime).toISOString().split('T')[0];
                    if(oDate === dateStr && o.status === 'finished' && o.dId) {
                        if(!map[o.dId]) map[o.dId] = { name: o.dName, bank: o.dBank, total: 0, count: 0 };
                        map[o.dId].total += Number(o.fare);
                        map[o.dId].count++;
                        grandTotal += Number(o.fare);
                    }
                });
                let html = `<h4>ğŸ“Š ${dateStr} çµç®—å ±è¡¨ (ä»Šæ—¥ 14:00 å‰åŒ¯æ¬¾)</h4><p>æ˜¨æ—¥ç¸½æ¥­ç¸¾ï¼š<span class="money">$${grandTotal}</span></p><table><tr><th>å¸æ©Ÿ/éŠ€è¡Œ</th><th>æ‡‰åŒ¯ç¸½é¡</th><th>è¶Ÿæ¬¡</th></tr>`;
                for(let id in map) {
                    html += `<tr><td>${map[id].name}<br><small>${map[id].bank}</small></td><td class="money">$${map[id].total}</td><td>${map[id].count}</td></tr>`;
                }
                document.getElementById('admin-content').innerHTML = html + '</table>';
            });
        }

        // --- 2. å¸æ©Ÿå¯©æ ¸èˆ‡æˆå“¡åéŒ„ä¿®å¾© ---
        function loadAdminVerify() {
            db.ref('drivers').on('value', snap => {
                let html = '<h4>ğŸ“„ å¸æ©Ÿå‡†å…¥å¯©æ ¸</h4>';
                snap.forEach(c => {
                    const d = c.val();
                    if(d.status === 'pending') {
                        html += `<div class="card" style="font-size:11px;">å¸æ©Ÿ:${d.name}<br><button onclick="approveDrv('${c.key}')" style="background:#00e676; padding:5px; border-radius:5px; border:none; margin-top:5px;">âœ… é€šéå¯©æ ¸ (é–‹å•Ÿæ¥å–®æ¬Šé™)</button></div>`;
                    }
                });
                document.getElementById('admin-content').innerHTML = html || 'ç›®å‰ç„¡å¾…å¯©æ ¸ã€‚';
            });
        }
        function approveDrv(id) { db.ref('drivers/'+id).update({status:'approved'}); alert('è©²å¸æ©Ÿå·²å¯é–‹å§‹æ¥å–®ï¼'); }

        function loadAdminMembers() {
            db.ref('drivers').on('value', snap => {
                let html = '<h4>ğŸ‘¥ å¸æ©Ÿå…¨è³‡æ–™åº« (æ°¸ä¹…ä¿ç•™)</h4><table><tr><th>å§“å/é›»è©±</th><th>è»Šç‰Œ/å¸³è™Ÿ</th><th>è­‰ä»¶åº« (é»åœ–æ”¾å¤§)</th></tr>';
                snap.forEach(c => {
                    const d = c.val();
                    html += `<tr><td>${d.name}<br>${d.phone}</td><td>${d.car}<br>${d.bank}</td><td>
                        <img class="img-thumb" src="${d.img1}" onclick="zoomImg(this.src)">
                        <img class="img-thumb" src="${d.img2}" onclick="zoomImg(this.src)">
                        <img class="img-thumb" src="${d.img3}" onclick="zoomImg(this.src)">
                    </td></tr>`;
                });
                document.getElementById('admin-content').innerHTML = html + '</table>';
            });
        }

        // --- 3. è©•åˆ†æ©Ÿåˆ¶ä¿®å¾© ---
        function rateTrip(orderId, role) {
            const score = prompt("è¡Œç¨‹å·²çµæŸï¼è«‹çµ¦äºˆ 1-5 æ˜Ÿè©•åƒ¹ï¼š");
            if(score >= 1 && score <= 5) {
                db.ref(`orders/${orderId}/${role}Score`).set(score);
                alert("æ„Ÿè¬æ‚¨çš„è©•åƒ¹ï¼");
                location.reload();
            }
        }

        // --- 4. å¸æ©Ÿè¨»å†Šèˆ‡ç…§ç‰‡è™•ç† ---
        function handleMultipleUpload(input) {
            const files = Array.from(input.files);
            uploadedImages = [];
            const container = document.getElementById('upload-previews');
            container.innerHTML = '';
            files.forEach((f, i) => {
                const r = new FileReader();
                r.onload = (e) => {
                    uploadedImages.push(e.target.result);
                    container.innerHTML += `<img src="${e.target.result}" style="width:50px; height:50px; object-fit:cover; border:1px solid #00e676;">`;
                };
                r.readAsDataURL(f);
            });
        }

        function saveDriverProfile() {
            const n = document.getElementById('d-name').value, c = document.getElementById('d-car').value;
            if(!n || uploadedImages.length < 3) return alert("è«‹å®Œæ•´å¡«å¯«ä¸¦ä¸Šå‚³è‡³å°‘ 3 å¼µè­‰ä»¶ç…§");
            db.ref('drivers/'+userId).set({
                name:n, phone:document.getElementById('d-phone').value, car:c,
                bank:document.getElementById('d-bank').value, status:'pending', userId:userId,
                img1: uploadedImages[0]||"", img2: uploadedImages[1]||"", img3: uploadedImages[2]||""
            }).then(() => { alert("è³‡æ–™å·²æäº¤ï¼è«‹å¾… Jasper å¯©æ ¸ã€‚"); location.reload(); });
        }

        // è¼”åŠ©åŠŸèƒ½
        function zoomImg(src) { document.getElementById('viewer-img').src = src; document.getElementById('img-viewer').style.display = 'flex'; }
        function selectRole(r) {
            document.getElementById('passenger-ui').style.display = (r==='passenger')?'block':'none';
            if(r==='driver') {
                db.ref('drivers/'+userId).once('value', s => {
                    const d = s.val();
                    if(!d) document.getElementById('driver-register').style.display='block';
                    else if(d.status==='approved') { document.getElementById('driver-ui').style.display='block'; listenOrders(); }
                    else alert("Jasper è€å¸«æ­£åœ¨å¯©æ ¸æ‚¨çš„è­‰ç…§ï¼Œè«‹ç¨å¾Œã€‚");
                });
            }
        }
        function postOrder() {
            const f = document.getElementById('p-fare').value;
            if(!f) return alert("è³‡è¨Šä¸å…¨");
            db.ref('orders').push().set({
                pPhone: document.getElementById('p-phone').value, fare: f,
                start: document.getElementById('p-start').value, end: document.getElementById('p-end').value,
                bookTime: document.getElementById('p-book-time').value,
                status: 'waiting', pId: userId, createTime: Date.now()
            });
            alert("è¨‚å–®å·²ç™¼é€ï¼è«‹ç­‰å¾…å°å¸³ã€‚");
        }
        function listenOrders() {
            db.ref('orders').on('value', snap => {
                const list = document.getElementById('order-list'); list.innerHTML = '';
                snap.forEach(c => {
                    const o = c.val(); if(o.status==='pay_confirmed') list.innerHTML += `<div class="card">ğŸ“ ${o.start}â”${o.end}<br>ğŸ’µ $${o.fare}<br><button class="btn-main" onclick="db.ref('orders/${c.key}').update({status:'accepted', dId:userId, dName:'å¸æ©Ÿ'})">æ¶å–®</button></div>`;
                });
            });
        }
        function loadAdminOrders() {
            db.ref('orders').on('value', snap => {
                let h = '<h4>ğŸ’° åŒ¯æ¬¾æ”¾å–® (å¾…æ ¸å¸³)</h4>';
                snap.forEach(c => {
                    const o = c.val(); if(o.status==='waiting') h += `<div class="card">${o.pPhone} | $${o.fare}<br><button onclick="db.ref('orders/${c.key}').update({status:'pay_confirmed'})">ç¢ºèªæ”¶éŒ¢ (æ”¾å–®)</button></div>`;
                });
                document.getElementById('admin-content').innerHTML = h || 'æš«ç„¡å¾…æ ¸å¸³ã€‚';
            });
        }
    </script>
</body>
</html>
