<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - å…¨æ–¹ä½ç›£æ§ç¸½ç«¯</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        .header { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; cursor: pointer; user-select: none; }
        .container { padding: 15px; max-width: 1000px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-role { flex: 1; padding: 15px; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-role.active { background: #00e676; color: #000; }
        input, select { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 15px; background: #00e676; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        /* ç®¡ç†å“¡åˆ†é æ¨£å¼ */
        .admin-box { display: none; margin-top: 10px; border: 2px solid #00e676; padding: 10px; border-radius: 12px; background: #000; }
        .admin-nav { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #333; margin-bottom: 15px; }
        .tab-btn { padding: 8px 12px; background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 13px; }
        .tab-btn.active { background: #00e676; color: #000; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
        th { background: #222; color: #00e676; }
        .img-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer; }
        .status-badge { padding: 2px 5px; border-radius: 4px; font-size: 10px; }
        .payout-high { color: #ffeb3b; font-weight: bold; }
        .report-img { width: 100px; display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="header" onclick="triggerAdmin()">ğŸš• Jasper æ™ºæ…§åª’åˆç®¡ç†ç¸½ç«¯</div>

    <div class="container">
        <div id="admin-ui" class="admin-box">
            <div class="admin-nav">
                <button class="tab-btn active" onclick="switchTab('p-orders')">ğŸ’° åŒ¯æ¬¾æ”¾å–®</button>
                <button class="tab-btn" onclick="switchTab('p-track')">ğŸ›°ï¸ é›™å‘å›å ±ç›£æ§</button>
                <button class="tab-btn" onclick="switchTab('p-verify')">ğŸ“„ å¸æ©Ÿå¯©æ ¸</button>
                <button class="tab-btn" onclick="switchTab('p-members')">ğŸ‘¥ å¸æ©Ÿæˆå“¡åˆ—è¡¨</button>
                <button class="tab-btn" onclick="switchTab('p-reports')">ğŸ“Š æ¯æ—¥/éš”æ—¥çµç®—å–®</button>
                <button onclick="closeAdmin()" style="margin-left: auto; background: none; border: none; color: #ff5252;">é—œé–‰</button>
            </div>
            <div id="admin-content"></div>
        </div>

        <div id="main-flow">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-role" id="btn-p" onclick="selectRole('passenger')">ä¹˜å®¢ç«¯</button>
                <button class="btn-role" id="btn-d" onclick="selectRole('driver')">å¸æ©Ÿç«¯</button>
            </div>
            </div>
    </div>

    <script>
        // Firebase åˆå§‹åŒ– (è«‹å¡«å…¥æ‚¨çš„æ­£ç¢ºé…ç½®)
        const firebaseConfig = {
            apiKey: "AIzaSyDqUA1Y2odbb51AN-MtE4bRLcz_cRm2A68",
            databaseURL: "https://jasper-taxi-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ADMIN_PASS = "Jasper888";
        let clickCount = 0;
        let userId = localStorage.getItem('jasper_user_id') || 'u'+Date.now();
        localStorage.setItem('jasper_user_id', userId);

        // ç®¡ç†å“¡æ¬Šé™è§¸ç™¼
        function triggerAdmin() {
            clickCount++;
            if(clickCount >= 5) {
                const p = prompt("è«‹è¼¸å…¥é–‹ç™¼è€…å¯†ç¢¼ï¼š");
                if(p === ADMIN_PASS) { document.getElementById('admin-ui').style.display='block'; switchTab('p-orders'); }
                clickCount = 0;
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderAdminContent(tab);
        }

        // --- é–‹ç™¼è€…å¾Œå°äº”å¤§æ¨¡çµ„é‚è¼¯ ---
        function renderAdminContent(tab) {
            const container = document.getElementById('admin-content');
            container.innerHTML = 'è¼‰å…¥ä¸­...';

            if(tab === 'p-orders') {
                db.ref('orders').on('value', snap => {
                    let html = '<h4>ğŸ’° å¾…æ ¸å¸³æ”¾å–®æ¸…å–®</h4><table><tr><th>æ™‚é–“</th><th>ä¹˜å®¢</th><th>èµ·é»/çµ‚é»</th><th>é‡‘é¡</th><th>æ“ä½œ</th></tr>';
                    snap.forEach(c => {
                        const o = c.val(); if(o.status === 'waiting') {
                        html += `<tr><td>${o.bookTime}</td><td>${o.pPhone}</td><td>${o.start}â”${o.end}</td><td>$${o.fare}</td><td><button onclick="approvePay('${c.key}')">ç¢ºèªæ”¶æ¬¾æ”¾å–®</button></td></tr>`;
                    }});
                    container.innerHTML = html + '</table>';
                });
            }

            if(tab === 'p-track') {
                db.ref('orders').on('value', snap => {
                    let html = '<h4>ğŸ›°ï¸ é›™å‘è¡Œç¨‹å›å ±ç›£æ§ (ä¸€å€‹æœˆä¿ç•™)</h4><table><tr><th>æ™‚é–“</th><th>è·¯ç·š</th><th>ä¹˜å®¢å›å ±(è»Šç‰Œ/è­‰ä»¶)</th><th>å¸æ©Ÿå›å ±</th><th>ç‹€æ…‹</th></tr>';
                    snap.forEach(c => {
                        const o = c.val(); if(o.status === 'in_progress' || o.status === 'finished') {
                        const pStatus = o.pReported ? 'âœ… å·²æ‹è­‰ç…§' : 'âŒ æœªå›å ±';
                        const dStatus = o.dReported ? 'âœ… å·²è¼‰å®Œ' : 'âŒ æœªè¼‰å®Œ';
                        html += `<tr><td>${o.bookTime}</td><td>${o.start}â”${o.end}</td><td>${pStatus}<br><img class="img-thumb" src="${o.pReportImg}"></td><td>${dStatus}</td><td>${o.status}</td></tr>`;
                    }});
                    container.innerHTML = html + '</table>';
                });
            }

            if(tab === 'p-verify') {
                db.ref('drivers').on('value', snap => {
                    let html = '<h4>ğŸ“„ å¸æ©Ÿå¯¦åå¯©æ ¸æ¸…å–®</h4><table><tr><th>å§“å</th><th>è»Šç‰Œ</th><th>è³‡æ–™é è¦½</th><th>æ“ä½œ</th></tr>';
                    snap.forEach(c => {
                        const d = c.val(); if(d.status === 'pending') {
                        html += `<tr><td>${d.name}</td><td>${d.car}</td><td><details><summary>æŸ¥çœ‹è­‰ä»¶</summary>èº«åˆ†è­‰ï¼š<img src="${d.idF}"><img src="${d.idB}"><br>åŸ·æ¥­è­‰ï¼š<img src="${d.licF}"><img src="${d.licB}"></details></td><td><button onclick="verifyDrv('${c.key}', 'approved')">é€šé</button> <button onclick="verifyDrv('${c.key}', 'rejected')">é§å›</button></td></tr>`;
                    }});
                    container.innerHTML = html + '</table>';
                });
            }

            if(tab === 'p-members') {
                db.ref('drivers').on('value', snap => {
                    let html = '<h4>ğŸ‘¥ å¸æ©Ÿæˆå“¡å…¨è³‡æ–™ (æ°¸ä¹…ä¿ç•™)</h4><table><tr><th>å§“å</th><th>æ‰‹æ©Ÿ</th><th>è»Šç‰Œ</th><th>æ”¶æ¬¾å¸³è™Ÿ</th><th>å®Œæ•´è­‰ä»¶æª”æ¡ˆåº«</th></tr>';
                    snap.forEach(c => {
                        const d = c.val();
                        html += `<tr><td>${d.name}</td><td>${d.phone}</td><td>${d.car}</td><td>${d.bank}</td><td><details><summary>é–‹å•Ÿæª”æ¡ˆ</summary>èº«åˆ†è­‰(æ­£):<img class="report-img" src="${d.idF}">èº«åˆ†è­‰(å):<img class="report-img" src="${d.idB}">åŸ·æ¥­è­‰(æ­£):<img class="report-img" src="${d.licF}">åŸ·æ¥­è­‰(å):<img class="report-img" src="${d.licB}"></details></td></tr>`;
                    });
                    container.innerHTML = html + '</table>';
                });
            }

            if(tab === 'p-reports') {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
                const dateKey = yesterday.toISOString().split('T')[0];
                db.ref('orders').once('value', snap => {
                    let map = {}; let grandTotal = 0;
                    snap.forEach(c => {
                        const o = c.val(); if(o.status === 'finished' && o.date === dateKey) {
                            if(!map[o.dId]) map[o.dId] = { name: o.dName, bank: o.dBank, total: 0 };
                            map[o.dId].total += Number(o.fare); grandTotal += Number(o.fare);
                        }
                    });
                    let html = `<h4>ğŸ“Š å ±è¡¨çµ±è¨ˆ (${dateKey})</h4><p>æ˜¨æ—¥æˆäº¤ç¸½é¡ï¼š$${grandTotal}</p><table><tr><th>æ‡‰ä»˜å¸æ©Ÿ</th><th>éŠ€è¡Œå¸³è™Ÿ</th><th>æ‡‰åŒ¯é‡‘é¡</th></tr>`;
                    for(let key in map) {
                        html += `<tr><td>${map[key].name}</td><td>${map[key].bank}</td><td class="payout-high">$${map[key].total}</td></tr>`;
                    }
                    container.innerHTML = html + '</table>';
                });
            }
        }

        // --- æ ¸å¿ƒæ“ä½œå‡½æ•¸ ---
        function approvePay(id) { db.ref('orders/'+id).update({status: 'pay_confirmed'}); alert('æ”¾å–®æˆåŠŸï¼å¸æ©Ÿç«¯å·²å¯è¦‹'); }
        function verifyDrv(id, status) { db.ref('drivers/'+id).update({status: status}); alert('å¸æ©Ÿç‹€æ…‹æ›´æ–°æˆåŠŸ'); }
        function closeAdmin() { document.getElementById('admin-ui').style.display='none'; }

        // --- å¸æ©Ÿç«¯è¨»å†Šæµç¨‹ (å« 6 å¼µè­‰ä»¶å½±åƒ) ---
        function saveDriverProfile() {
            // ...æ­¤è™•å¯¦ä½œä¸Šå‚³é‚è¼¯ï¼Œå°‡ å§“å/æ‰‹æ©Ÿ/è»Šç‰Œ/éŠ€è¡Œ/èº«åˆ†è­‰æ­£å/åŸ·æ¥­è­‰æ­£å å…¨éƒ¨ push åˆ° Firebase 
            // ç‹€æ…‹è¨­ç‚º pending å¾…é–‹ç™¼è€…å¯©æ ¸
        }
    </script>
</body>
</html>
