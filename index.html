<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ™ºæ…§åª’åˆç³»çµ± - è²¡å‹™èˆ‡ç¶­å®‰ç¸½ç«¯</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        .header { padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; cursor: pointer; }
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; }
        .admin-section { display: none; margin-top: 20px; }
        .tab-btn { padding: 10px 20px; background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px; }
        .tab-btn.active { background: #00e676; color: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #333; padding: 10px; text-align: left; }
        th { background: #2c2c2c; color: #00e676; }
        .ban-tag { background: #ff5252; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
        .money-tag { color: #00e676; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header" onclick="triggerAdmin()">ğŸš• Jasper æ™ºæ…§åª’åˆç®¡ç†ç¸½ç«¯</div>

    <div class="container">
        <div id="admin-ui" class="admin-section">
            <div style="margin-bottom: 15px;">
                <button class="tab-btn active" onclick="switchTab('report')">ğŸ“… æ¯æ—¥å°å¸³å ±è¡¨</button>
                <button class="tab-btn" onclick="switchTab('blacklist')">ğŸš« åœæ¬Šåå–®</button>
                <button onclick="document.getElementById('admin-ui').style.display='none'" style="float:right; background:none; border:none; color:#888;">é—œé–‰</button>
            </div>

            <div id="tab-report" class="card">
                <h3 id="report-date-title">æ˜¨æ—¥åŒ¯æ¬¾æ¸…å–® (14:00 å‰éœ€å®Œæˆ)</h3>
                <div id="payout-summary" style="background: #004d40; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    è¨ˆç®—ä¸­...
                </div>
                <table>
                    <thead>
                        <tr><th>å¸æ©Ÿå§“å</th><th>è»Šç‰Œ</th><th>éŠ€è¡Œå¸³è™Ÿ</th><th>æ‡‰åŒ¯ç¸½é¡</th><th>æ˜ç´°</th></tr>
                    </thead>
                    <tbody id="report-body"></tbody>
                </table>
            </div>

            <div id="tab-blacklist" class="card" style="display:none;">
                <h3>ğŸš« ç›®å‰åœæ¬Šä¸­å¸æ©Ÿ</h3>
                <table>
                    <thead>
                        <tr><th>å¸æ©Ÿ ID/å§“å</th><th>é•è¦åŸå› </th><th>åœæ¬Šæˆªæ­¢</th><th>è§£å°</th></tr>
                    </thead>
                    <tbody id="blacklist-body"></tbody>
                </table>
            </div>
        </div>

        <div id="main-flow">
            <p style="text-align:center; color:#666;">è«‹é€£é»æ¨™é¡Œ 5 ä¸‹é€²å…¥ç®¡ç†å¾Œå°</p>
        </div>
    </div>

    <script>
        // Firebase èˆ‡åŸºç¤é…ç½®
        const firebaseConfig = { /* ... ä¿æŒæ‚¨çš„ Firebase é…ç½® ... */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ADMIN_PASS = "Jasper888";

        // åˆ‡æ›åˆ†é 
        function switchTab(tab) {
            document.getElementById('tab-report').style.display = tab==='report'?'block':'none';
            document.getElementById('tab-blacklist').style.display = tab==='blacklist'?'block':'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if(tab==='report') generateDailyReport();
            if(tab==='blacklist') loadBlacklist();
        }

        // 1. æ¯æ—¥å ±è¡¨å½™æ•´é‚è¼¯
        function generateDailyReport() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];
            document.getElementById('report-date-title').innerText = `${dateStr} å®Œè³½å°å¸³å ±è¡¨ (ä»Šæ—¥ 14:00 åŒ¯æ¬¾)`;

            db.ref('orders').once('value', snap => {
                const driverMap = {};
                let grandTotal = 0;

                snap.forEach(child => {
                    const o = child.val();
                    // ç¯©é¸æ˜¨æ—¥ã€å·²å®Œæˆã€å·²ç¢ºèªä»˜éŒ¢çš„å–®
                    const orderDate = new Date(o.createTime).toISOString().split('T')[0];
                    if (orderDate === dateStr && o.status === 'finished' && o.dId) {
                        if (!driverMap[o.dId]) {
                            driverMap[o.dId] = { 
                                name: o.dName, 
                                car: o.dCar, 
                                bank: 'è¼‰å…¥ä¸­...', 
                                total: 0, 
                                count: 0 
                            };
                        }
                        driverMap[o.dId].total += Number(o.fare);
                        driverMap[o.dId].count++;
                        grandTotal += Number(o.fare);
                    }
                });

                const tbody = document.getElementById('report-body');
                tbody.innerHTML = '';
                
                for (let dId in driverMap) {
                    const d = driverMap[dId];
                    // ç•°æ­¥æŠ“å–å¸æ©ŸéŠ€è¡Œå¸³è™Ÿ
                    db.ref('drivers/' + dId + '/bank').once('value', bSnap => {
                        const bankInfo = bSnap.val() || 'æœªå¡«å¯«';
                        tbody.innerHTML += `
                            <tr>
                                <td>${d.name}</td>
                                <td>${d.car}</td>
                                <td>${bankInfo}</td>
                                <td class="money-tag">$${d.total}</td>
                                <td>${d.count} è¶Ÿ</td>
                            </tr>`;
                    });
                }
                document.getElementById('payout-summary').innerHTML = `æ˜¨æ—¥ç¸½æˆäº¤é¡ï¼š<b style="font-size:18px;">$${grandTotal}</b><br><small>è«‹æ–¼ä»Šæ—¥ 14:00 å‰å®ŒæˆåŒ¯æ¬¾</small>`;
            });
        }

        // 2. é•è¦åå–®æŸ¥è©¢
        function loadBlacklist() {
            db.ref('blacklist/drivers').on('value', snap => {
                const tbody = document.getElementById('blacklist-body');
                tbody.innerHTML = '';
                const now = Date.now();

                snap.forEach(child => {
                    const b = child.val();
                    const timeLeft = Math.round((b.until - now) / 3600000);
                    if (timeLeft > 0) {
                        tbody.innerHTML += `
                            <tr>
                                <td>${child.key}</td>
                                <td>${b.reason}</td>
                                <td>å‰©é¤˜ ${timeLeft} å°æ™‚</td>
                                <td><button onclick="db.ref('blacklist/drivers/${child.key}').remove()">æ‰‹å‹•è§£å°</button></td>
                            </tr>`;
                    } else {
                        // æ™‚é–“åˆ°è‡ªå‹•ç§»é™¤
                        db.ref('blacklist/drivers/' + child.key).remove();
                    }
                });
            });
        }

        // é€²å…¥å¾Œå°çš„è§¸ç™¼å™¨
        let clickCount = 0;
        function triggerAdmin() {
            clickCount++;
            if (clickCount >= 5) {
                const p = prompt("Jasper è€å¸«ï¼Œè«‹è¼¸å…¥æˆæ¬Šå¯†ç¢¼ï¼š");
                if (p === ADMIN_PASS) {
                    document.getElementById('admin-ui').style.display = 'block';
                    generateDailyReport();
                }
                clickCount = 0;
            }
        }
    </script>
</body>
</html>
